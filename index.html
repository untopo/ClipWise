<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Work Time Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @keyframes heartbeat {
            0% { transform: scale(1); }
            25% { transform: scale(1.1); }
            40% { transform: scale(1); }
            60% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .animate-beat {
            animation: heartbeat 1s infinite;
            display: inline-block;
        }

        .amount-input { width: 100px; }
        .scrollable-table { max-height: 400px; overflow-y: auto; }
        .fade-in-out { animation: fadeInOut 2.5s forwards; }
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(-10px);}
            10% { opacity: 1; transform: translateY(0);}
            90% { opacity: 1;}
            100% { opacity: 0; transform: translateY(-10px);}
        }

        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .animate-gradient {
            background-size: 200% auto;
            animation: gradient 4s linear infinite;
        }

        /* Pulse animation for icons */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .animate-pulse {
            animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        /* Dark Mode Toggle & Date Picker Styles */
        #dark-toggle {
            transform: scale(1);
            transition: all 0.3s ease;
        }

        #dark-toggle:hover {
            transform: scale(1.1);
        }

        #dark-toggle i {
            transform: rotate(0deg);
            transition: transform 0.3s ease;
        }

        #dark-toggle:active i {
            transform: rotate(360deg);
        }

        /* Date picker styles - consolidated */
        input[type="date"],
        input[type="time"],
        input[type="datetime-local"] {
            background-color: white !important;
            border: 1px solid #e2e8f0;
            color: #1a202c;
            border-radius: 0.375rem;
            padding: 0.375rem 0.75rem;
        }

        html.dark input[type="date"],
        html.dark input[type="time"],
        html.dark input[type="datetime-local"] {
            background-color: #1e293b !important;
            border-color: #475569;
            color: #f1f5f9;
        }

        input[type="date"]::-webkit-calendar-picker-indicator,
        input[type="time"]::-webkit-calendar-picker-indicator,
        input[type="datetime-local"]::-webkit-calendar-picker-indicator {
            background-color: transparent;
            cursor: pointer;
            padding: 0.25rem;
            filter: invert(0.8) brightness(1.2) saturate(0.8);
        }

        html.dark input[type="date"]::-webkit-calendar-picker-indicator,
        html.dark input[type="time"]::-webkit-calendar-picker-indicator,
        html.dark input[type="datetime-local"]::-webkit-calendar-picker-indicator {
            filter: invert(1) brightness(0.8) saturate(0.8);
        }

        /* Focus states */
        input[type="date"]:focus,
        input[type="time"]:focus,
        input[type="datetime-local"]:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
        }

        /* Enhanced Dark Mode Styles */
        html.dark {
            color-scheme: dark;
        }

        html.dark body {
            background-color: #0f172a;
            color: #f1f5f9;
        }

        html.dark .card,
        html.dark .modal,
        html.dark #call-modal,
        html.dark #settings-modal {
            background-color: #1e293b;
            border: 1px solid #334155;
        }

        html.dark input,
        html.dark select,
        html.dark textarea {
            background-color: #334155;
            border-color: #475569;
            color: #f1f5f9;
        }

        /* Call log totals dark mode fix */
        html.dark #total-minutes,
        html.dark #total-earnings {
            color: #f1f5f9 !important;
        }

        html.dark .bg-gray-50 {
            background-color: #1f2937 !important;
        }

        html.dark tfoot tr {
            background-color: #1f2937 !important;
            color: #f1f5f9 !important;
        }

        /* Edit button visibility fixes */
        .edit-rate-btn,
        .edit-call-btn {
            display: inline-flex !important;
            align-items: center;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            background-color: #3b82f6;
            color: white !important;
            font-size: 0.75rem;
            font-weight: 600;
            gap: 0.25rem;
            transition: background-color 0.2s;
            margin: 0 0.25rem;
        }

        .edit-rate-btn:hover,
        .edit-call-btn:hover {
            background-color: #2563eb;
        }

        /* Improved text contrast in dark mode */
        html.dark .text-gray-900 {
            color: #f1f5f9 !important;
        }

        html.dark .text-gray-800 {
            color: #e2e8f0 !important;
        }

        html.dark .text-gray-700 {
            color: #cbd5e1 !important;
        }

        html.dark .bg-white {
            background-color: #1e293b !important;
        }

        html.dark .border-gray-200 {
            border-color: #334155 !important;
        }

        /* Rates card improvements */
        .rate-edit-form {
            background-color: white;
            padding: 0.5rem;
            border-radius: 0.75rem;
            margin-bottom: 1rem;
            width: 100%;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        html.dark .rate-edit-form {
            background-color: #1e293b;
            border: 1px solid #475569;
        }

        .rate-edit-form input {
            width: 100%;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            border-radius: 0.25rem;
            border: 1px solid #e2e8f0;
            transition: all 0.2s ease;
        }

        html.dark .rate-edit-form input {
            background-color: #334155;
            border-color: #475569;
            color: #f1f5f9;
        }

        .rate-edit-form button {
            transition: all 0.2s ease;
        }

        .rates-list-item {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            background-color: #f8fafc;
            border-radius: 0.375rem;
        }

        html.dark .rates-list-item {
            background-color: #1e293b;
        }

        .call-log-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        .call-log-table th,
        .call-log-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        html.dark .call-log-table th,
        html.dark .call-log-table td {
            border-bottom: 1px solid #334155;
        }

        .call-log-table tr:hover {
            background-color: #f1f5f9;
        }

        html.dark .call-log-table tr:hover {
            background-color: #334155;
        }

        .tag {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            background-color: #e2e8f0;
            color: #4a5568;
            font-size: 0.875rem;
        }

        html.dark .tag {
            background-color: #475569;
            color: #f1f5f9;
        }

        /* Modal styles with dark mode */
        #call-modal,
        #settings-modal {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            width: 90%;
        }

        html.dark #call-modal,
        html.dark #settings-modal {
            background-color: #1e293b;
            border-color: #475569;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        #call-modal input,
        #call-modal select,
        #settings-modal input,
        #settings-modal select {
            width: 100%;
            padding: 8px;
            margin: 4px 0 12px;
            border-radius: 4px;
            border: 1px solid #e2e8f0;
        }

        html.dark #call-modal input,
        html.dark #call-modal select,
        html.dark #settings-modal input,
        html.dark #settings-modal select {
            background-color: #334155;
            border-color: #475569;
            color: #f1f5f9;
        }

        /* Button styles with dark mode */
        .btn-primary {
            background-color: #3b82f6;
            color: white;
            transition: background-color 0.2s;
        }

        .btn-primary:hover {
            background-color: #2563eb;
        }

        html.dark .btn-primary {
            background-color: #3b82f6;
        }

        html.dark .btn-primary:hover {
            background-color: #1d4ed8;
        }

        /* Call log table specific styles */
        .call-log-table td button {
            opacity: 1 !important;
            visibility: visible !important;
        }

        /* Make goal save button always visible */
        #goal-form button[type="submit"] {
            display: inline-flex !important;
            opacity: 1 !important;
            visibility: visible !important;
            background-color: #22c55e;
            color: white;
            padding: 0.375rem 0.75rem;
            border-radius: 0.375rem;
        }

        #goal-form button[type="submit"]:hover {
            background-color: #16a34a;
        }

        /* Style for Add Rate button */
        #show-rate-add {
            background-color: #dbeafe !important;
            color: #2563eb !important;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        #show-rate-add:hover {
            background-color: #bfdbfe !important;
        }

        html.dark #show-rate-add {
            background-color: #1e3a8a !important;
            color: #60a5fa !important;
        }

        html.dark #show-rate-add:hover {
            background-color: #1e40af !important;
        }

        /* Hidden file input */
        #file-input {
            display: none;
        }

        /* Responsive containers */
        .tracker-container {
            width: 100%;
            max-width: 320px;
        }

        @media (max-width: 640px) {
            .tracker-container {
                max-width: 100%;
            }

            .rate-edit-form button {
                width: 100%;
                margin-bottom: 0.5rem;
            }

            .rate-edit-form .flex {
                flex-direction: column;
            }
        }
        /* SortableJS drag handle cursor */
        .drag-handle {
            cursor: move; /* Change cursor on hover over drag handle */
        }
        
    </style>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors">
<div class="container mx-auto px-4 py-8 max-w-7xl">
    <div class="flex justify-end mb-4 gap-2">
        <button id="settings-toggle" aria-label="Open settings"
            class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 transition-all duration-300 focus:outline-none">
            <i class="fas fa-cog text-gray-600 dark:text-gray-300 transition-transform duration-300"></i>
        </button>
        <button id="dark-toggle" aria-label="Toggle dark mode"
            class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 transition-all duration-300 focus:outline-none">
            <i class="fas fa-sun text-yellow-500 hidden dark:block"></i>
            <i class="fas fa-moon text-gray-600 dark:text-gray-300 block dark:hidden"></i>
        </button>
    </div>

    <header class="mb-8 text-center">
        <h1 class="text-4xl md:text-5xl font-extrabold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent mb-3 animate-gradient">
            Work Time Tracker
        </h1>
        <p class="text-lg md:text-xl text-gray-700 dark:text-gray-300 font-light tracking-wide mb-2">
            <span class="inline-block">
                <i class="fas fa-clock text-blue-500 dark:text-blue-400 mr-2 animate-pulse"></i>
                Track Your Time
            </span>
            <span class="mx-2">•</span>
            <span class="inline-block">
                <i class="fas fa-chart-line text-purple-500 dark:text-purple-400 mr-2 animate-pulse"></i>
                Monitor Earnings
            </span>
        </p>
        <p class="text-md md:text-lg font-semibold text-gray-800 dark:text-gray-200 bg-gradient-to-r from-blue-100 to-purple-100 dark:from-gray-900 dark:to-black py-1 px-3 rounded-full inline-block shadow-sm">
            By Interpreters for Interpreters
        </p>
    </header>

<div class="flex flex-col md:flex-row items-start justify-center gap-12 mb-8">
    <div class="tracker-container dark:bg-gray-800 rounded-xl shadow p-6 flex flex-col items-center w-full">
        <div class="flex flex-col items-center mb-2">
            <div class="bg-blue-100 dark:bg-blue-950 rounded-full w-16 h-16 flex items-center justify-center mb-3">
                <i class="fas fa-phone-volume text-3xl text-primary dark:text-blue-300"></i>
            </div>
            <h2 class="text-lg font-semibold mb-2 text-dark dark:text-gray-200">Call Controls</h2>
        </div>
        <div class="w-full mb-4">
    <label for="select-call-rate" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Select Rate</label>
    <select id="select-call-rate"
        class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200 bg-white dark:bg-gray-800">
    </select>
</div>
        <div class="flex flex-col gap-2 w-full">
            <button id="add-call-btn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 dark:bg-blue-500 dark:hover:bg-blue-600 transition w-full flex items-center justify-center gap-2">
                <i class="fas fa-plus"></i> Add Call
            </button>
            <button id="start-call-btn" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 dark:hover:bg-green-800 transition w-full flex items-center justify-center gap-2">
                <i class="fas fa-play"></i> Start Call
            </button>
            <button id="end-call-btn" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 dark:hover:bg-red-800 transition w-full flex items-center justify-center gap-2">
                <i class="fas fa-stop"></i> End Call
            </button>
        </div>
        <div id="live-call-info" class="mt-4 w-full" style="display:none;">
            <div class="flex flex-col items-center bg-green-50 dark:bg-green-900 rounded-lg p-3 shadow-inner">
                <span class="text-green-700 dark:text-green-300 font-semibold text-sm mb-1">Ongoing Call</span>
                <span id="live-call-timer" class="font-mono text-xl text-green-900 dark:text-green-200 mb-1">00:00:00</span>
                <span id="live-call-earnings" class="font-mono text-lg text-green-800 dark:text-green-100">$0.00 earned</span>
            </div>
        </div>
    </div>

    <div class="flex flex-col w-full tracker-container">
        <div class="dark:bg-gray-800 rounded-xl shadow p-6 w-full mb-6">
            <div class="flex flex-col items-center mb-4">
                <div class="bg-purple-100 dark:bg-purple-950 rounded-full w-16 h-16 flex items-center justify-center mb-3">
                    <i class="fas fa-dollar-sign text-3xl text-purple-500 dark:text-purple-300"></i>
                </div>
                <h2 class="text-lg font-semibold text-dark dark:text-gray-200">Rates</h2>
            </div>
            <div id="rates-list" class="mb-4">
            </div>
            <button id="show-rate-add" class="w-full flex items-center justify-center gap-2 py-1">
                <i class="fas fa-plus"></i> Add Rate
            </button>
            <form id="rate-form" class="rate-edit-form" style="display: none;">
                <input type="text" id="rate-name" placeholder="Rate Name" maxlength="50"
                    class="w-full mb-2 px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                <div class="flex items-center mb-2">
                    <span class="text-gray-600 dark:text-gray-300 mr-2">$</span>
                    <input type="number" id="rate-amount" placeholder="Amount" step="0.01" min="0.01" max="999999"
                        class="flex-1 px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                    <span class="text-gray-600 dark:text-gray-300 ml-2">/min</span>
                </div>
                <div class="flex gap-2">
                    <button type="submit"
                        class="flex-1 bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 transition">
                        Save
                    </button>
                    <button type="button" id="cancel-rate-add"
                        class="flex-1 bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-200 px-4 py-2 rounded hover:bg-gray-400 dark:hover:bg-gray-700 transition">
                        Cancel
                    </button>
                </div>
            </form>
        </div>

        <div class="dark:bg-gray-800 rounded-xl shadow p-6 w-full">
            <div class="flex flex-col items-center mb-4">
                <div class="bg-green-100 dark:bg-green-950 rounded-full w-16 h-16 flex items-center justify-center mb-3">
                    <i class="fas fa-bullseye text-3xl text-green-500 dark:text-green-300"></i>
                </div>
                <h2 class="text-lg font-semibold text-dark dark:text-gray-200">Daily Goal</h2>
            </div>
            <form id="goal-form" class="flex items-center gap-2">
                <div class="flex-1">
                    <div class="flex items-center">
                        <span class="text-gray-600 dark:text-gray-300 mr-2">$</span>
                        <input type="number" id="goal-amount" placeholder="Amount" step="0.01" min="0" max="999999"
                            class="flex-1 px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                </div>
                <button type="submit" class="px-4 py-2 rounded transition-colors duration-200">
                    <i class="fas fa-save"></i>
                </button>
            </form>
            <div class="mt-4">
                <div class="relative pt-1">
                    <div class="flex mb-2 items-center justify-between">
                        <div>
                            <span id="goal-progress-text"
                                class="text-xs font-semibold inline-block text-green-600 dark:text-green-400">
                                0%
                            </span>
                        </div>
                        <div class="text-right">
                            <span id="goal-amount-display"
                                class="text-xs font-semibold inline-block text-green-600 dark:text-green-400">
                                $0 / $0
                            </span>
                        </div>
                    </div>
                    <div class="flex h-2 mb-4 overflow-hidden bg-green-200 rounded dark:bg-green-900">
                        <div id="goal-progress-bar"
                            class="flex flex-col justify-center overflow-hidden bg-green-500"
                            role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden mb-8">
    <div class="p-6">
        <h2 class="text-2xl font-semibold text-gray-900 dark:text-gray-100 mb-4">
            <i class="fas fa-chart-bar text-purple-500 mr-2"></i>Call Statistics
        </h2>
        <div class="flex justify-between items-center mb-6">
            <div class="flex items-center gap-4">
                <input type="date" id="stats-date-picker"
                       class="px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200"
                />
                <button id="current-date-btn"
                        class="px-4 py-2 bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300 rounded-lg hover:bg-blue-200 dark:hover:bg-blue-800 transition-colors">
                    Current Date
                </button>
            </div>
        </div>
        
        <div id="sortable-stats-cards" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <div class="sortable-card bg-blue-50 dark:bg-blue-900/40 p-4 rounded-lg">
                <h3 class="text-blue-700 dark:text-blue-300 font-medium mb-2 drag-handle">
                    <i class="fas fa-clock mr-2"></i>Average Call Duration
                </h3>
                <p id="avg-duration" class="text-2xl font-bold text-blue-800 dark:text-blue-200">00:00:00</p>
            </div>
            <div class="sortable-card bg-green-50 dark:bg-green-900/40 p-4 rounded-lg">
                <h3 class="text-green-700 dark:text-green-300 font-medium mb-2 drag-handle">
                    <i class="fas fa-bullseye mr-2"></i>Goal Progress
                </h3>
                <p id="goal-estimate" class="text-2xl font-bold text-green-800 dark:text-green-200">-- mins to goal</p>
            </div>
            <div class="sortable-card bg-yellow-50 dark:bg-yellow-900/40 p-4 rounded-lg">
                <h3 class="text-yellow-700 dark:text-yellow-300 font-medium mb-2 drag-handle">
                    <i class="fas fa-chart-line mr-2"></i>Today's Earnings
                </h3>
                <p id="today-earnings" class="text-2xl font-bold text-yellow-800 dark:text-yellow-200">$0.00</p>
            </div>
        </div>

        <div id="monthly-earnings-cards" class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-purple-50 dark:bg-purple-900/40 p-4 rounded-lg">
                <h3 class="text-purple-700 dark:text-purple-300 font-medium mb-2">
                    <i class="fas fa-calendar-alt mr-2"></i>First Half of Month
                </h3>
                <p class="text-lg text-purple-800 dark:text-purple-200 font-bold">
                    <span id="first-half-earnings">$0.00</span>
                </p>
            </div>
            <div class="bg-purple-50 dark:bg-purple-900/40 p-4 rounded-lg">
                <h3 class="text-purple-700 dark:text-purple-300 font-medium mb-2">
                    <i class="fas fa-calendar-alt mr-2"></i>Second Half of Month
                </h3>
                <p class="text-lg text-purple-800 dark:text-purple-200 font-bold">
                    <span id="second-half-earnings">$0.00</span>
                </p>
            </div>
            <div class="bg-purple-50 dark:bg-purple-900/40 p-4 rounded-lg">
                <h3 class="text-purple-700 dark:text-purple-300 font-medium mb-2">
                    <i class="fas fa-dollar-sign mr-2"></i>Total in Current Month
                </h3>
                <p class="text-lg text-purple-800 dark:text-purple-200 font-bold">
                    <span id="monthly-total-earnings">$0.00</span>
                </p>
            </div>
        </div>

        <div id="payment-cycle-earnings-cards" class="grid grid-cols-1 md:grid-cols-3 gap-4 hidden">
            <div class="bg-purple-50 dark:bg-purple-900/40 p-4 rounded-lg">
                <h3 class="text-purple-700 dark:text-purple-300 font-medium mb-2">
                    <i class="fas fa-money-bill-wave mr-2"></i>Current Cycle Earnings
                </h3>
                <p id="cycle-earnings" class="text-2xl font-bold text-purple-800 dark:text-purple-200">
                    $0.00
                </p>
            </div>
            
            <div class="bg-purple-50 dark:bg-purple-900/40 p-4 rounded-lg">
                <h3 class="text-purple-700 dark:text-purple-300 font-medium mb-2">
                    <i class="fas fa-calendar-check mr-2"></i>Cycle Progress
                </h3>
                <div class="text-sm text-gray-700 dark:text-gray-300">
                    <p class="mb-1">
                        <i class="fas fa-calendar-day mr-2"></i>
                        Start: <span id="cycle-start-date">N/A</span>
                    </p>
                    <p class="mb-1">
                        <i class="fas fa-calendar-day mr-2"></i>
                        End: <span id="cycle-end-date">N/A</span>
                    </p>
                    <p>
                        <i class="fas fa-calendar-check mr-2"></i>
                        Days Left: <span id="days-until-end">N/A</span>
                    </p>
                </div>
            </div>
            <div class="bg-purple-50 dark:bg-purple-900/40 p-4 rounded-lg">
                <h3 class="text-purple-700 dark:text-purple-300 font-medium mb-2">
                    <i class="fas fa-clock mr-2"></i>Pay Day Countdown
                </h3>
                <div class="text-sm text-gray-700 dark:text-gray-300">
                    <p class="mb-1">
                        <i class="fas fa-calendar-dollar mr-2"></i>
                        Pay Date: <span id="pay-date">N/A</span>
                    </p>
                    <p>
                        <i class="fas fa-clock mr-2"></i>
                        Days to Pay: <span id="days-until-pay">N/A</span>
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden mb-8">
    <div class="p-6">
        <div class="flex flex-col md:flex-row items-center justify-between gap-4 mb-6">
            <h2 class="text-2xl font-semibold text-gray-900 dark:text-gray-100">
                <i class="fas fa-history text-blue-500 mr-2"></i>Call Log
            </h2>
            <div class="flex flex-wrap items-center gap-4">
                <div class="flex items-center gap-2">
                    <span class="text-gray-600 dark:text-gray-400">Total Time:</span>
                    <span id="total-minutes" class="font-mono text-lg">00:00:00</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-gray-600 dark:text-gray-400">Total Earnings:</span>
                    <span id="total-earnings" class="font-mono text-lg">$0.00</span>
                </div>
            </div>
        </div>
        <div class="overflow-x-auto">
            <table class="call-log-table w-full">
                <thead>
                    <tr class="text-left">
                        <th class="font-semibold">Date</th>
                        <th class="font-semibold">Duration</th>
                        <th class="font-semibold">Rate</th>
                        <th class="font-semibold">Earned</th>
                        <th class="font-semibold pl-4">Actions</th>
                    </tr>
                </thead>
                <tbody id="call-log">
                </tbody>
                <tfoot>
                    <tr class="bg-gray-50 dark:bg-gray-800">
                        <td colspan="5" class="py-4 text-center text-gray-500 dark:text-gray-400">
                            End of call log
                        </td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>

<div id="call-modal" style="display: none;"
    role="dialog" aria-labelledby="modal-title" aria-modal="true" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100" id="modal-title">Add Call</h3>
            <button id="close-modal" aria-label="Close modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="call-form">
            <div class="mb-4">
                <label for="call-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Date & Time</label>
                <input type="datetime-local" id="call-date" required class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200">
            </div>
            <div class="mb-4">
                <label for="call-duration-hours" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Duration (HH:MM:SS)</label>
                <div class="flex gap-2">
                    <input type="number" id="call-duration-hours" min="0" max="24" placeholder="HH" aria-label="Hours" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200">
                    <input type="number" id="call-duration-minutes" min="0" max="59" placeholder="MM" aria-label="Minutes" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200">
                    <input type="number" id="call-duration-seconds" min="0" max="59" placeholder="SS" aria-label="Seconds" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200">
                </div>
            </div>
            <div class="mb-6">
                <label for="call-rate" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Rate</label>
                <select id="call-rate" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200">
                </select>
            </div>
            <div class="flex justify-end gap-3">
                <button type="button" id="cancel-call" class="px-4 py-2 text-gray-700 bg-gray-200 rounded hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600"> Cancel </button>
                <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"> Save </button>
            </div>
        </form>
    </div>
</div>

<div id="settings-modal" style="display: none;"
    role="dialog" aria-labelledby="settings-modal-title" aria-modal="true" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100" id="settings-modal-title">Settings</h3>
            <button id="close-settings-modal" aria-label="Close settings" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="space-y-4">
            <div class="border-b border-gray-200 dark:border-gray-700 pb-4">
                <h4 class="text-lg font-medium text-gray-900 dark:text-gray-100 mb-3">Data Management</h4>
                <div class="flex flex-col gap-2">
                    <button id="export-data" class="flex items-center gap-2 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors">
                        <i class="fas fa-download"></i> Export Data
                    </button>
                    <label for="import-file" class="flex items-center gap-2 px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 transition-colors cursor-pointer">
                        <i class="fas fa-upload"></i> Import Data
                    </label>
                    <input type="file" id="import-file" accept=".json" class="hidden">
                </div>
            </div>
            <div class="border-b border-gray-200 dark:border-gray-700 pb-4">
                <h4 class="text-lg font-medium text-gray-900 dark:text-gray-100 mb-3">Storage</h4>
                <div class="mb-2">
                    <div class="flex justify-between text-sm text-gray-600 dark:text-gray-400 mb-1">
                        <span>Storage Used</span>
                        <span id="storage-used">Calculating...</span>
                    </div>
                    <div class="h-2 bg-gray-200 dark:bg-gray-700 rounded">
                        <div id="storage-bar" class="h-2 bg-blue-500 rounded" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            <div class="border-b border-gray-200 dark:border-gray-700 pb-4">
                <div class="flex justify-between items-center mb-3">
                    <h4 class="text-lg font-medium text-gray-900 dark:text-gray-100">Payment Cycles</h4>
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="payment-cycles-toggle" class="sr-only peer">
                        <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                        <span class="ml-3 text-sm font-medium text-gray-900 dark:text-gray-300">Enable Payment Cycles</span>
                    </label>
                </div>
                <div id="payment-cycles-config" class="hidden">
                    <div class="mb-3">
                        <button id="add-cycle" class="flex items-center gap-2 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors">
                            <i class="fas fa-plus"></i> Add Payment Cycle
                        </button>
                    </div>
                    <div class="max-h-48 overflow-y-auto space-y-2" id="payment-cycle-list">
                    </div>
                </div>
            </div>
            <div class="flex justify-between items-center">
                <h4 class="text-lg font-medium text-gray-900 dark:text-gray-100">Reset Data</h4>
                <button id="reset-app" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition-colors">
                    <i class="fas fa-trash-alt"></i> Reset
                </button>
            </div>
        </div>
    </div>
</div>
<div id="call-detail-modal" style="display: none;" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100">Call Details</h3>
            <button id="close-detail-modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="call-detail-content">
            </div>
    </div>
</div>

<footer class="text-center text-sm text-gray-500 dark:text-gray-400 mt-8">
    <div class="flex justify-center items-center gap-4">
        <a id="privacy-policy" href="#" class="hover:underline">Privacy Policy</a>
        <span>•</span>
        <a id="terms-of-service" href="#" class="hover:underline">Terms of Service</a>
        <span>•</span>
        <a id="support" href="mailto:support@example.com" class="hover:underline">Support</a>
    </div>
    <p class="mt-2">&copy; 2025 Work Time Tracker. All rights reserved.</p>
</footer>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Function to safely parse JSON from localStorage
        const safeParseJSON = (key, defaultValue) => {
            try {
                const item = localStorage.getItem(key);
                return item ? JSON.parse(item) : defaultValue;
            } catch (e) {
                console.error(`Failed to parse JSON from localStorage for key "${key}":`, e);
                return defaultValue;
            }
        };

        const saveRates = (rates) => localStorage.setItem('rates', JSON.stringify(rates));
        const saveCalls = (calls) => localStorage.setItem('calls', JSON.stringify(calls));
        const saveGoal = (goal) => localStorage.setItem('goal', JSON.stringify(goal));
        const saveSettings = (settings) => localStorage.setItem('settings', JSON.stringify(settings));
        const savePaymentCycles = (cycles) => localStorage.setItem('paymentCycles', JSON.stringify(cycles));

        const getRates = () => safeParseJSON('rates', []);
        const getCalls = () => safeParseJSON('calls', []);
        const getGoal = () => safeParseJSON('goal', { amount: 0 });
        const getSettings = () => safeParseJSON('settings', { theme: 'light', lastExport: null, paymentCyclesEnabled: false });
        const getPaymentCycles = () => safeParseJSON('paymentCycles', []);

        const formatDuration = (minutes) => {
            const h = Math.floor(minutes / 60);
            const m = Math.floor(minutes % 60);
            const s = Math.round((minutes - Math.floor(minutes)) * 60);
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        };

        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2
            }).format(amount);
        };

        const calculateTotalDuration = (calls) => {
            const totalMinutes = calls.reduce((sum, call) => sum + call.duration, 0);
            return totalMinutes;
        };

        const calculateTotalEarnings = (calls) => {
            const totalEarnings = calls.reduce((sum, call) => sum + call.earned, 0);
            return totalEarnings;
        };
        
        // Timer variables
        let callStartTime = null;
        let activeTimers = new Set();
        let currentLiveTimerId = null;

        const liveCallInfo = document.getElementById('live-call-info');
        const liveCallTimer = document.getElementById('live-call-timer');
        const liveCallEarnings = document.getElementById('live-call-earnings');
        const startCallBtn = document.getElementById('start-call-btn');
        const endCallBtn = document.getElementById('end-call-btn');
        const addCallBtn = document.getElementById('add-call-btn');

        startCallBtn.addEventListener('click', () => {
            if (currentLiveTimerId) {
                alert('A live call is already in progress.');
                return;
            }

            const selectedRateElement = document.getElementById('select-call-rate');
            const rateId = selectedRateElement.value;
            const rate = getRates().find(r => r.id === rateId);
            if (!rate) {
                alert('Please select a valid rate before starting a call.');
                return;
            }

            callStartTime = Date.now();
            liveCallInfo.style.display = 'block';

            let secondsElapsed = 0;
            let currentEarnings = 0;

            const timerId = setInterval(() => {
                secondsElapsed++;
                const minutesElapsed = secondsElapsed / 60;
                currentEarnings = minutesElapsed * rate.amount;

                liveCallTimer.textContent = formatDuration(minutesElapsed);
                liveCallEarnings.textContent = `${formatCurrency(currentEarnings)} earned`;
            }, 1000);

            currentLiveTimerId = timerId;
            activeTimers.add(timerId);

            addCallBtn.disabled = true;
        });

        endCallBtn.addEventListener('click', () => {
            if (!currentLiveTimerId) {
                return;
            }

            const endTime = Date.now();
            const durationMs = endTime - callStartTime;
            const durationMinutes = durationMs / 60000;

            const selectedRateElement = document.getElementById('select-call-rate');
            const rateId = selectedRateElement.value;
            const rate = getRates().find(r => r.id === rateId);

            if (rate) {
                const earned = durationMinutes * rate.amount;
                const newCall = {
                    id: Date.now().toString(),
                    date: new Date().toISOString(),
                    duration: durationMinutes,
                    rateId: rate.id,
                    rateName: rate.name,
                    rateAmount: rate.amount,
                    earned: earned
                };

                const calls = getCalls();
                calls.push(newCall);
                saveCalls(calls);
                displayCalls();
                updateStatistics();
                updateStorageInfo();
            }

            clearInterval(currentLiveTimerId);
            activeTimers.delete(currentLiveTimerId);
            currentLiveTimerId = null;
            liveCallInfo.style.display = 'none';
            addCallBtn.disabled = false;
        });
        
        const ratesList = document.getElementById('rates-list');
        const rateForm = document.getElementById('rate-form');
        const showRateAddBtn = document.getElementById('show-rate-add');
        const cancelRateAddBtn = document.getElementById('cancel-rate-add');

        showRateAddBtn.addEventListener('click', () => {
            rateForm.style.display = 'block';
            showRateAddBtn.style.display = 'none';
        });

        cancelRateAddBtn.addEventListener('click', () => {
            rateForm.reset();
            rateForm.style.display = 'none';
            showRateAddBtn.style.display = 'flex';
        });

        rateForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const rateName = document.getElementById('rate-name').value;
            const rateAmount = parseFloat(document.getElementById('rate-amount').value);

            if (rateName && !isNaN(rateAmount) && rateAmount > 0) {
                const newRate = {
                    id: Date.now().toString(),
                    name: rateName,
                    amount: rateAmount
                };
                const rates = getRates();
                rates.push(newRate);
                saveRates(rates);
                displayRates();
                rateForm.reset();
                rateForm.style.display = 'none';
                showRateAddBtn.style.display = 'flex';
                updateRateSelects();
            }
        });

        const displayRates = () => {
            const rates = getRates();
            ratesList.innerHTML = rates.map(rate => `
                <div class="rates-list-item flex items-center justify-between bg-gray-100 dark:bg-gray-700 p-3 rounded-lg shadow-sm mb-2">
                    <span class="text-lg font-semibold text-gray-800 dark:text-gray-200">${rate.name}</span>
                    <span class="text-md text-gray-600 dark:text-gray-400">$${rate.amount.toFixed(2)} / min</span>
                    <button data-id="${rate.id}" class="delete-rate-btn text-red-500 hover:text-red-700 ml-4 transition-colors">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            `).join('');

            document.querySelectorAll('.delete-rate-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const rateId = e.currentTarget.dataset.id;
                    let rates = getRates();
                    rates = rates.filter(r => r.id !== rateId);
                    saveRates(rates);
                    displayRates();
                    updateRateSelects();
                });
            });
        };

        const callLog = document.getElementById('call-log');
        const callModal = document.getElementById('call-modal');
        const openCallModalBtn = document.getElementById('add-call-btn');
        const closeCallModalBtn = document.getElementById('close-modal');
        const callForm = document.getElementById('call-form');

        openCallModalBtn.addEventListener('click', () => {
            callModal.style.display = 'flex';
        });

        closeCallModalBtn.addEventListener('click', () => {
            callModal.style.display = 'none';
            callForm.reset();
        });

        callModal.addEventListener('click', (e) => {
            if (e.target === callModal) {
                callModal.style.display = 'none';
                callForm.reset();
            }
        });

        const callDetailModal = document.getElementById('call-detail-modal');
        const closeDetailModalBtn = document.getElementById('close-detail-modal');
        const callDetailContent = document.getElementById('call-detail-content');

        closeDetailModalBtn.addEventListener('click', () => {
            callDetailModal.style.display = 'none';
        });

        callDetailModal.addEventListener('click', (e) => {
            if (e.target === callDetailModal) {
                callDetailModal.style.display = 'none';
            }
        });

        callForm.addEventListener('submit', (e) => {
            e.preventDefault();

            const dateInput = document.getElementById('call-date').value;
            const hoursInput = parseInt(document.getElementById('call-duration-hours').value) || 0;
            const minutesInput = parseInt(document.getElementById('call-duration-minutes').value) || 0;
            const secondsInput = parseInt(document.getElementById('call-duration-seconds').value) || 0;
            const rateId = document.getElementById('call-rate').value;

            if (!dateInput || rateId === '0') {
                alert('Please fill in all required fields.');
                return;
            }

            const durationMinutes = hoursInput * 60 + minutesInput + secondsInput / 60;
            if (durationMinutes <= 0) {
                alert('Duration must be greater than zero.');
                return;
            }

            const rates = getRates();
            const rate = rates.find(r => r.id === rateId);
            const earned = durationMinutes * rate.amount;

            const newCall = {
                id: Date.now().toString(),
                date: new Date(dateInput).toISOString(),
                duration: durationMinutes,
                rateId: rate.id,
                rateName: rate.name,
                rateAmount: rate.amount,
                earned: earned
            };

            const calls = getCalls();
            calls.push(newCall);
            saveCalls(calls);
            displayCalls();
            updateStatistics();
            updateStorageInfo();
            
            callModal.style.display = 'none';
            callForm.reset();
        });

        const displayCalls = () => {
            const calls = getCalls().sort((a, b) => new Date(b.date) - new Date(a.date));
            callLog.innerHTML = calls.map(call => `
                <tr class="border-b dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                    <td class="py-3 px-2 text-sm text-gray-700 dark:text-gray-300">${new Date(call.date).toLocaleString()}</td>
                    <td class="py-3 px-2 text-sm text-gray-700 dark:text-gray-300">${formatDuration(call.duration)}</td>
                    <td class="py-3 px-2 text-sm text-gray-700 dark:text-gray-300">${call.rateName}</td>
                    <td class="py-3 px-2 text-sm font-semibold text-green-600 dark:text-green-400">${formatCurrency(call.earned)}</td>
                    <td class="py-3 px-2 pl-4 flex gap-2">
                        <button data-id="${call.id}" class="view-call-btn text-blue-500 hover:text-blue-700">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button data-id="${call.id}" class="delete-call-btn text-red-500 hover:text-red-700">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                </tr>
            `).join('');

            document.querySelectorAll('.view-call-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const callId = e.currentTarget.dataset.id;
                    const calls = getCalls();
                    const call = calls.find(c => c.id === callId);
                    if (call) {
                        callDetailContent.innerHTML = `
                            <p class="mb-2"><span class="font-semibold text-gray-700 dark:text-gray-300">Date & Time:</span> ${new Date(call.date).toLocaleString()}</p>
                            <p class="mb-2"><span class="font-semibold text-gray-700 dark:text-gray-300">Duration:</span> ${formatDuration(call.duration)}</p>
                            <p class="mb-2"><span class="font-semibold text-gray-700 dark:text-gray-300">Rate Name:</span> ${call.rateName}</p>
                            <p class="mb-2"><span class="font-semibold text-gray-700 dark:text-gray-300">Rate Amount:</span> ${formatCurrency(call.rateAmount)}/min</p>
                            <p class="mb-2"><span class="font-semibold text-gray-700 dark:text-gray-300">Total Earned:</span> ${formatCurrency(call.earned)}</p>
                            <div class="mt-4 flex justify-end">
                                <button data-id="${call.id}" id="edit-call-btn" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                            </div>
                        `;
                        callDetailModal.style.display = 'flex';
                    }
                });
            });

            document.querySelectorAll('.delete-call-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const callId = e.currentTarget.dataset.id;
                    if (confirm('Are you sure you want to delete this call record?')) {
                        let calls = getCalls();
                        calls = calls.filter(c => c.id !== callId);
                        saveCalls(calls);
                        displayCalls();
                        updateStatistics();
                        updateStorageInfo();
                    }
                });
            });
        };

        const updateRateSelects = () => {
            const rates = getRates();
            const selectElements = document.querySelectorAll('#select-call-rate, #call-rate');
            
            selectElements.forEach(select => {
                select.innerHTML = '<option value="0">Select a rate...</option>';
                rates.forEach(rate => {
                    const option = document.createElement('option');
                    option.value = rate.id;
                    option.textContent = `${rate.name} ($${rate.amount.toFixed(2)}/min)`;
                    select.appendChild(option);
                });
            });
        };

        const statsDatePicker = document.getElementById('stats-date-picker');
        statsDatePicker.valueAsDate = new Date();

        statsDatePicker.addEventListener('change', () => {
            updateStatistics();
        });

        document.getElementById('current-date-btn').addEventListener('click', () => {
            statsDatePicker.valueAsDate = new Date();
            updateStatistics();
        });

        const updateStatistics = () => {
            const calls = getCalls();
            const selectedDate = statsDatePicker.value;
            const todayCalls = calls.filter(call => {
                return new Date(call.date).toISOString().slice(0, 10) === selectedDate;
            });

            const totalDurationToday = calculateTotalDuration(todayCalls);
            const totalEarningsToday = calculateTotalEarnings(todayCalls);
            const avgDuration = todayCalls.length > 0 ? totalDurationToday / todayCalls.length : 0;

            document.getElementById('avg-duration').textContent = formatDuration(avgDuration);
            document.getElementById('today-earnings').textContent = formatCurrency(totalEarningsToday);

            // Goal progress
            const goal = getGoal();
            document.getElementById('goal-amount-display').textContent = `${formatCurrency(totalEarningsToday)} / ${formatCurrency(goal.amount)}`;
            const goalProgress = goal.amount > 0 ? (totalEarningsToday / goal.amount) * 100 : 0;
            document.getElementById('goal-progress-bar').style.width = `${Math.min(goalProgress, 100)}%`;
            document.getElementById('goal-progress-text').textContent = `${Math.round(Math.min(goalProgress, 100))}%`;
            
            // Goal estimate
            const minutesToGoal = goal.amount > totalEarningsToday && goal.amount > 0 ? (goal.amount - totalEarningsToday) / (getRates()[0]?.amount || 1) : 0;
            document.getElementById('goal-estimate').textContent = minutesToGoal > 0 ? `${Math.round(minutesToGoal)} mins to goal` : "Goal Reached!";

            // Monthly earnings
            const today = new Date(selectedDate);
            const currentMonthCalls = calls.filter(call => {
                const callDate = new Date(call.date);
                return callDate.getMonth() === today.getMonth() && callDate.getFullYear() === today.getFullYear();
            });

            const firstHalfEarnings = calculateTotalEarnings(currentMonthCalls.filter(call => new Date(call.date).getDate() <= 15));
            const secondHalfEarnings = calculateTotalEarnings(currentMonthCalls.filter(call => new Date(call.date).getDate() > 15));
            const monthlyTotal = firstHalfEarnings + secondHalfEarnings;

            document.getElementById('first-half-earnings').textContent = formatCurrency(firstHalfEarnings);
            document.getElementById('second-half-earnings').textContent = formatCurrency(secondHalfEarnings);
            document.getElementById('monthly-total-earnings').textContent = formatCurrency(monthlyTotal);
            
            // Payment cycles
            renderPaymentCycles();
        };

        const goalForm = document.getElementById('goal-form');
        goalForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const goalAmount = parseFloat(document.getElementById('goal-amount').value);
            if (!isNaN(goalAmount) && goalAmount >= 0) {
                saveGoal({ amount: goalAmount });
                updateStatistics();
            }
        });

        // Settings Modal
        const settingsToggleBtn = document.getElementById('settings-toggle');
        const settingsModal = document.getElementById('settings-modal');
        const closeSettingsModalBtn = document.getElementById('close-settings-modal');

        settingsToggleBtn.addEventListener('click', () => {
            settingsModal.style.display = 'flex';
        });

        closeSettingsModalBtn.addEventListener('click', () => {
            settingsModal.style.display = 'none';
        });

        settingsModal.addEventListener('click', (e) => {
            if (e.target === settingsModal) {
                settingsModal.style.display = 'none';
            }
        });

        // Dark Mode Toggle
        const darkToggleBtn = document.getElementById('dark-toggle');
        const html = document.documentElement;

        const updateDarkMode = () => {
            const settings = getSettings();
            if (settings.theme === 'dark') {
                html.classList.add('dark');
            } else {
                html.classList.remove('dark');
            }
        };

        darkToggleBtn.addEventListener('click', () => {
            const settings = getSettings();
            settings.theme = settings.theme === 'dark' ? 'light' : 'dark';
            saveSettings(settings);
            updateDarkMode();
        });

        // Data management
        document.getElementById('export-data').addEventListener('click', () => {
            const data = {
                rates: getRates(),
                calls: getCalls(),
                goal: getGoal(),
                settings: getSettings(),
                paymentCycles: getPaymentCycles(),
            };
            const dataStr = JSON.stringify(data, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'work-time-tracker-data.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            const settings = getSettings();
            settings.lastExport = new Date().toISOString();
            saveSettings(settings);
            updateStorageInfo();
        });

        document.getElementById('import-file').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        if (confirm('Importing data will overwrite your current data. Are you sure?')) {
                            saveRates(importedData.rates || []);
                            saveCalls(importedData.calls || []);
                            saveGoal(importedData.goal || { amount: 0 });
                            saveSettings({ ...getSettings(), ...importedData.settings });
                            savePaymentCycles(importedData.paymentCycles || []);
                            
                            // Re-initialize UI
                            displayRates();
                            displayCalls();
                            updateRateSelects();
                            updateStatistics();
                            updateDarkMode();
                            updateStorageInfo();
                            renderPaymentCycles();
                            alert('Data imported successfully!');
                        }
                    } catch (error) {
                        alert('Failed to import data. Please check if the file is a valid JSON.');
                        console.error('Import error:', error);
                    }
                };
                reader.readAsText(file);
            }
        });

        document.getElementById('reset-app').addEventListener('click', () => {
            if (confirm('This will delete all your data (calls, rates, goals, and settings). This action cannot be undone. Are you sure?')) {
                localStorage.clear();
                alert('All data has been deleted. The application will now reload.');
                window.location.reload();
            }
        });

        const updateStorageInfo = () => {
            const storageUsed = (JSON.stringify(localStorage).length / 1024).toFixed(2);
            const storageLimit = 5120; // 5MB limit on most browsers
            const usagePercent = (storageUsed / storageLimit) * 100;

            document.getElementById('storage-used').textContent = `${storageUsed} KB`;
            document.getElementById('storage-bar').style.width = `${Math.min(usagePercent, 100)}%`;

            const settings = getSettings();
            if (settings.lastExport) {
                const exportDate = new Date(settings.lastExport).toLocaleString();
                // You can add a span to show the last export date if needed
            }
        };

        // Payment Cycles
        const paymentCyclesToggle = document.getElementById('payment-cycles-toggle');
        const paymentCyclesConfig = document.getElementById('payment-cycles-config');
        const paymentCycleList = document.getElementById('payment-cycle-list');
        
        const updatePaymentCyclesUI = () => {
            const settings = getSettings();
            paymentCyclesToggle.checked = settings.paymentCyclesEnabled;
            if (settings.paymentCyclesEnabled) {
                paymentCyclesConfig.classList.remove('hidden');
                document.getElementById('monthly-earnings-cards').classList.add('hidden');
                document.getElementById('payment-cycle-earnings-cards').classList.remove('hidden');
            } else {
                paymentCyclesConfig.classList.add('hidden');
                document.getElementById('monthly-earnings-cards').classList.remove('hidden');
                document.getElementById('payment-cycle-earnings-cards').classList.add('hidden');
            }
        };

        paymentCyclesToggle.addEventListener('change', (e) => {
            const settings = getSettings();
            settings.paymentCyclesEnabled = e.target.checked;
            saveSettings(settings);
            updatePaymentCyclesUI();
            updateStatistics(); // Recalculate based on new view
        });

        document.getElementById('add-cycle').addEventListener('click', () => {
            const name = prompt("Enter a name for the payment cycle (e.g., 'Company A Pay Cycle'):");
            const startDate = prompt("Enter the start day of the month (1-31):");
            const endDate = prompt("Enter the end day of the month (1-31):");
            const payDay = prompt("Enter the pay day of the month (1-31):");

            if (name && startDate && endDate && payDay) {
                const newCycle = {
                    id: Date.now().toString(),
                    name: name,
                    startDay: parseInt(startDate),
                    endDay: parseInt(endDate),
                    payDay: parseInt(payDay)
                };
                const cycles = getPaymentCycles();
                cycles.push(newCycle);
                savePaymentCycles(cycles);
                renderPaymentCycles();
            } else {
                alert("All fields are required.");
            }
        });

        const renderPaymentCycles = () => {
            const cycles = getPaymentCycles();
            paymentCycleList.innerHTML = cycles.map(cycle => `
                <div class="flex items-center justify-between p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                    <span>${cycle.name} (Days ${cycle.startDay}-${cycle.endDay})</span>
                    <button data-id="${cycle.id}" class="delete-cycle-btn text-red-500 hover:text-red-700">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            `).join('');

            document.querySelectorAll('.delete-cycle-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const cycleId = e.currentTarget.dataset.id;
                    if (confirm('Are you sure you want to delete this payment cycle?')) {
                        let cycles = getPaymentCycles();
                        cycles = cycles.filter(c => c.id !== cycleId);
                        savePaymentCycles(cycles);
                        renderPaymentCycles();
                    }
                });
            });

            const settings = getSettings();
            if (settings.paymentCyclesEnabled && cycles.length > 0) {
                const activeCycle = cycles[0]; // For now, we'll use the first one as the active one
                const today = new Date();
                
                // Calculate cycle dates
                let cycleStartDate = new Date(today.getFullYear(), today.getMonth(), activeCycle.startDay);
                let cycleEndDate = new Date(today.getFullYear(), today.getMonth(), activeCycle.endDay);
                let payDate = new Date(today.getFullYear(), today.getMonth(), activeCycle.payDay);

                // Adjust for month boundaries
                if (activeCycle.startDay > activeCycle.endDay) {
                    if (today.getDate() < activeCycle.startDay) {
                        cycleStartDate = new Date(today.getFullYear(), today.getMonth() - 1, activeCycle.startDay);
                        cycleEndDate = new Date(today.getFullYear(), today.getMonth(), activeCycle.endDay);
                        payDate = new Date(today.getFullYear(), today.getMonth(), activeCycle.payDay);
                    } else {
                        cycleStartDate = new Date(today.getFullYear(), today.getMonth(), activeCycle.startDay);
                        cycleEndDate = new Date(today.getFullYear(), today.getMonth() + 1, activeCycle.endDay);
                        payDate = new Date(today.getFullYear(), today.getMonth() + 1, activeCycle.payDay);
                    }
                }
                
                // If pay date has passed this month, show next month's
                if (today.getDate() > activeCycle.payDay && activeCycle.startDay <= activeCycle.endDay) {
                    payDate = new Date(today.getFullYear(), today.getMonth() + 1, activeCycle.payDay);
                }

                // Calculate cycle earnings
                const allCalls = getCalls();
                const cycleCalls = allCalls.filter(call => {
                    const callDate = new Date(call.date);
                    return callDate >= cycleStartDate && callDate <= cycleEndDate;
                });
                const cycleEarnings = calculateTotalEarnings(cycleCalls);

                document.getElementById('cycle-earnings').textContent = formatCurrency(cycleEarnings);
                document.getElementById('cycle-start-date').textContent = cycleStartDate.toLocaleDateString();
                document.getElementById('cycle-end-date').textContent = cycleEndDate.toLocaleDateString();

                const msPerDay = 1000 * 60 * 60 * 24;
                const daysUntilEnd = Math.ceil((cycleEndDate - today) / msPerDay);
                document.getElementById('days-until-end').textContent = daysUntilEnd >= 0 ? daysUntilEnd : "0";
                
                document.getElementById('pay-date').textContent = payDate.toLocaleDateString();
                const daysUntilPay = Math.ceil((payDate - today) / msPerDay);
                document.getElementById('days-until-pay').textContent = daysUntilPay >= 0 ? daysUntilPay : "0";
            } else {
                // Clear out cycle info if disabled or no cycles
                document.getElementById('cycle-earnings').textContent = "$0.00";
                document.getElementById('cycle-start-date').textContent = "N/A";
                document.getElementById('cycle-end-date').textContent = "N/A";
                document.getElementById('days-until-end').textContent = "N/A";
                document.getElementById('pay-date').textContent = "N/A";
                document.getElementById('days-until-pay').textContent = "N/A";
            }
        };


        // SortableJS initialization for Call Statistics cards
        const statsCardsContainer = document.getElementById('sortable-stats-cards');
        if (statsCardsContainer) {
            new Sortable(statsCardsContainer, {
                animation: 150,
                ghostClass: 'bg-gray-200 dark:bg-gray-700',
                handle: '.drag-handle', // Specify drag handle class
                draggable: '.sortable-card' // Specify draggable item class
            });
        }
        
        // This is a global function to handle keyboard shortcuts for modals
        const handleModalKeyboard = (e) => {
            if (e.key === 'Escape') {
                callModal.style.display = 'none';
                callForm.reset();
            }
        };

        const handleSettingsKeyboard = (e) => {
            if (e.key === 'Escape') {
                settingsModal.style.display = 'none';
            }
        };


        // Global Event Listeners
// This consolidates the duplicated keydown listeners.
document.addEventListener('keydown', (e) => {
    if (callModal && callModal.style.display === 'flex') {
        handleModalKeyboard(e);
    } else if (settingsModal && settingsModal.style.display === 'flex') {
        handleSettingsKeyboard(e);
    }
});
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            activeTimers.forEach(timerId => clearInterval(timerId));
            activeTimers.clear();
        });

        // Footer button handlers
        document.getElementById('privacy-policy')?.addEventListener('click', () => {
            alert('Privacy Policy: This app stores all data locally in your browser. No data is sent to external servers.');
        });

        document.getElementById('terms-of-service')?.addEventListener('click', () => {
            alert('Terms of Service: This app is provided "as is" without any warranties. Use at your own discretion.');
        });
        
        // Initialize displays and add event listeners
        displayRates();
        displayCalls();
        updateStatistics();
        updateStorageInfo();
        renderPaymentCycles();
    });
</script>
</body>
</html>
