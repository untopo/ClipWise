<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Work Time Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @keyframes heartbeat {
            0% { transform: scale(1);
[cite_start][cite: 244] }
            25% { transform: scale(1.1);
[cite_start][cite: 245] }
            40% { transform: scale(1);
[cite_start][cite: 246] }
            60% { transform: scale(1.1);
[cite_start][cite: 247] }
            100% { transform: scale(1);
[cite_start][cite: 248] }
        }

        .animate-beat {
            animation: heartbeat 1s infinite;
[cite_start][cite: 249] display: inline-block;
        }

        .amount-input { width: 100px;
[cite_start][cite: 250] }
        .scrollable-table { max-height: 400px; overflow-y: auto;
[cite_start][cite: 251] }
        .fade-in-out { animation: fadeInOut 2.5s forwards;
[cite_start][cite: 252] }
        @keyframes fadeInOut {
            0% { opacity: 0;
[cite_start][cite: 253] transform: translateY(-10px);}
            10% { opacity: 1;
[cite_start][cite: 254] transform: translateY(0);}
            90% { opacity: 1;}
            100% { opacity: 0;
[cite_start][cite: 255] transform: translateY(-10px);}
        }

        @keyframes gradient {
            0% { background-position: 0% 50%;
[cite_start][cite: 256] }
            50% { background-position: 100% 50%;
[cite_start][cite: 257] }
            100% { background-position: 0% 50%;
[cite_start][cite: 258] }
        }

        .animate-gradient {
            background-size: 200% auto;
[cite_start][cite: 259] animation: gradient 4s linear infinite;
        }

        /* Pulse animation for icons */
        @keyframes pulse {
            0%, 100% { opacity: 1;
[cite_start][cite: 260] }
            50% { opacity: 0.7;
[cite_start][cite: 261] }
        }

        .animate-pulse {
            animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
[cite_start][cite: 262] }

        /* Dark Mode Toggle & Date Picker Styles */
        #dark-toggle {
            transform: scale(1);
[cite_start][cite: 263] transition: all 0.3s ease;
        }

        #dark-toggle:hover {
            transform: scale(1.1);
[cite_start][cite: 264] }

        #dark-toggle i {
            transform: rotate(0deg);
[cite_start][cite: 265] transition: transform 0.3s ease;
        }

        #dark-toggle:active i {
            transform: rotate(360deg);
[cite_start][cite: 266] }

        /* Date picker styles - consolidated */
        input[type="date"],
        input[type="time"],
        input[type="datetime-local"] {
            background-color: white !important;
[cite_start][cite: 267] border: 1px solid #e2e8f0;
            color: #1a202c;
            border-radius: 0.375rem;
            padding: 0.375rem 0.75rem;
[cite_start][cite: 268] }

        html.dark input[type="date"],
        html.dark input[type="time"],
        html.dark input[type="datetime-local"] {
            background-color: #1e293b !important;
[cite_start][cite: 269] border-color: #475569;
            color: #f1f5f9;
        }

        input[type="date"]::-webkit-calendar-picker-indicator,
        input[type="time"]::-webkit-calendar-picker-indicator,
        input[type="datetime-local"]::-webkit-calendar-picker-indicator {
            background-color: transparent;
[cite_start][cite: 270] cursor: pointer;
            padding: 0.25rem;
            filter: invert(0.8) brightness(1.2) saturate(0.8);
        }

        html.dark input[type="date"]::-webkit-calendar-picker-indicator,
        html.dark input[type="time"]::-webkit-calendar-picker-indicator,
        html.dark input[type="datetime-local"]::-webkit-calendar-picker-indicator {
            filter: invert(1) brightness(0.8) saturate(0.8);
[cite_start][cite: 271] }

        /* Focus states */
        input[type="date"]:focus,
        input[type="time"]:focus,
        input[type="datetime-local"]:focus {
            outline: none;
[cite_start][cite: 272] border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
[cite_start][cite: 273] }

        /* Enhanced Dark Mode Styles */
        html.dark {
            color-scheme: dark;
[cite_start][cite: 274] }

        html.dark body {
            background-color: #0f172a;
[cite_start][cite: 275] color: #f1f5f9;
        }

        html.dark .card,
        html.dark .modal,
        html.dark #call-modal,
        html.dark #settings-modal {
            background-color: #1e293b;
[cite_start][cite: 276] border: 1px solid #334155;
        }

        html.dark input,
        html.dark select,
        html.dark textarea {
            background-color: #334155;
[cite_start][cite: 277] border-color: #475569;
            color: #f1f5f9;
        }

        /* Call log totals dark mode fix */
        html.dark #total-minutes,
        html.dark #total-earnings {
            color: #f1f5f9 !important;
[cite_start][cite: 278] }

        html.dark .bg-gray-50 {
            background-color: #1f2937 !important;
[cite_start][cite: 279] }

        html.dark tfoot tr {
            background-color: #1f2937 !important;
[cite_start][cite: 280] color: #f1f5f9 !important;
        }

        /* Edit button visibility fixes */
        .edit-rate-btn,
        .edit-call-btn {
            display: inline-flex !important;
[cite_start][cite: 281] align-items: center;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            background-color: #3b82f6;
            color: white !important;
            font-size: 0.75rem;
            font-weight: 600;
            gap: 0.25rem;
[cite_start][cite: 282] transition: background-color 0.2s;
            margin: 0 0.25rem;
        }

        .edit-rate-btn:hover,
        .edit-call-btn:hover {
            background-color: #2563eb;
[cite_start][cite: 283] }

        /* Improved text contrast in dark mode */
        html.dark .text-gray-900 {
            color: #f1f5f9 !important;
[cite_start][cite: 284] }

        html.dark .text-gray-800 {
            color: #e2e8f0 !important;
[cite_start][cite: 285] }

        html.dark .text-gray-700 {
            color: #cbd5e1 !important;
[cite_start][cite: 286] }

        html.dark .bg-white {
            background-color: #1e293b !important;
[cite_start][cite: 287] }

        html.dark .border-gray-200 {
            border-color: #334155 !important;
[cite_start][cite: 288] }

        /* Rates card improvements */
        .rate-edit-form {
            background-color: white;
[cite_start][cite: 289] padding: 0.5rem;
            border-radius: 0.75rem;
            margin-bottom: 1rem;
            width: 100%;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
[cite_start][cite: 290] }

        html.dark .rate-edit-form {
            background-color: #1e293b;
[cite_start][cite: 291] border: 1px solid #475569;
        }

        .rate-edit-form input {
            width: 100%;
[cite_start][cite: 292] padding: 0.5rem;
            margin-bottom: 0.5rem;
            border-radius: 0.25rem;
            border: 1px solid #e2e8f0;
            transition: all 0.2s ease;
[cite_start][cite: 293] }

        html.dark .rate-edit-form input {
            background-color: #334155;
[cite_start][cite: 294] border-color: #475569;
            color: #f1f5f9;
        }

        .rate-edit-form button {
            transition: all 0.2s ease;
[cite_start][cite: 295] }

        .rates-list-item {
            display: flex;
[cite_start][cite: 296] align-items: center;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            background-color: #f8fafc;
            border-radius: 0.375rem;
[cite_start][cite: 297] }

        html.dark .rates-list-item {
            background-color: #1e293b;
[cite_start][cite: 298] }

        .call-log-table {
            width: 100%;
[cite_start][cite: 299] border-collapse: separate;
            border-spacing: 0;
        }

        .call-log-table th,
        .call-log-table td {
            padding: 12px;
[cite_start][cite: 300] text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        html.dark .call-log-table th,
        html.dark .call-log-table td {
            border-bottom: 1px solid #334155;
[cite_start][cite: 301] }

        .call-log-table th {
            font-weight: 600;
[cite_start][cite: 302] background-color: #f8fafc;
        }

        html.dark .call-log-table th {
            background-color: #1e293b;
[cite_start][cite: 303] color: #f1f5f9;
        }

        .call-log-table tr:hover {
            background-color: #f1f5f9;
[cite_start][cite: 304] }

        html.dark .call-log-table tr:hover {
            background-color: #334155;
[cite_start][cite: 305] }

        .tag {
            display: inline-block;
[cite_start][cite: 306] padding: 4px 8px;
            border-radius: 4px;
            background-color: #e2e8f0;
            color: #4a5568;
            font-size: 0.875rem;
[cite_start][cite: 307] }

        html.dark .tag {
            background-color: #475569;
[cite_start][cite: 308] color: #f1f5f9;
        }

        /* Modal styles with dark mode */
        #call-modal,
        #settings-modal {
            background-color: white;
[cite_start][cite: 309] border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            width: 90%;
[cite_start][cite: 310] }

        html.dark #call-modal,
        html.dark #settings-modal {
            background-color: #1e293b;
[cite_start][cite: 311] border-color: #475569;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
[cite_start][cite: 312] }

        #call-modal input,
        #call-modal select,
        #settings-modal input,
        #settings-modal select {
            width: 100%;
[cite_start][cite: 313] padding: 8px;
            margin: 4px 0 12px;
            border-radius: 4px;
            border: 1px solid #e2e8f0;
[cite_start][cite: 314] }

        html.dark #call-modal input,
        html.dark #call-modal select,
        html.dark #settings-modal input,
        html.dark #settings-modal select {
            background-color: #334155;
[cite_start][cite: 315] border-color: #475569;
            color: #f1f5f9;
        }

        /* Button styles with dark mode */
        .btn-primary {
            background-color: #3b82f6;
[cite_start][cite: 316] color: white;
            transition: background-color 0.2s;
        }

        .btn-primary:hover {
            background-color: #2563eb;
[cite_start][cite: 317] }

        html.dark .btn-primary {
            background-color: #3b82f6;
[cite_start][cite: 318] }

        html.dark .btn-primary:hover {
            background-color: #1d4ed8;
[cite_start][cite: 319] }

        /* Call log table specific styles */
        .call-log-table td button {
            opacity: 1 !important;
[cite_start][cite: 320] visibility: visible !important;
        }

        /* Make goal save button always visible */
        #goal-form button[type="submit"] {
            display: inline-flex !important;
[cite_start][cite: 321] opacity: 1 !important;
            visibility: visible !important;
            background-color: #22c55e;
            color: white;
            padding: 0.375rem 0.75rem;
            border-radius: 0.375rem;
[cite_start][cite: 322] }

        #goal-form button[type="submit"]:hover {
            background-color: #16a34a;
[cite_start][cite: 323] }

        /* Style for Add Rate button */
        #show-rate-add {
            background-color: #dbeafe !important;
[cite_start][cite: 324] color: #2563eb !important;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
[cite_start][cite: 325] }

        #show-rate-add:hover {
            background-color: #bfdbfe !important;
[cite_start][cite: 326] }

        html.dark #show-rate-add {
            background-color: #1e3a8a !important;
[cite_start][cite: 327] color: #60a5fa !important;
        }

        html.dark #show-rate-add:hover {
            background-color: #1e40af !important;
[cite_start][cite: 328] }

        /* Hidden file input */
        #file-input {
            display: none;
[cite_start][cite: 329] }

        /* Responsive containers */
        .tracker-container {
            width: 100%;
[cite_start][cite: 330] max-width: 320px;
        }

        @media (max-width: 640px) {
            .tracker-container {
                max-width: 100%;
[cite_start][cite: 331] }

            .rate-edit-form button {
                width: 100%;
[cite_start][cite: 332] margin-bottom: 0.5rem;
            }

            .rate-edit-form .flex {
                flex-direction: column;
[cite_start][cite: 333] }
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors">
<div class="container mx-auto px-4 py-8 max-w-7xl">
    <div class="flex justify-end mb-4 gap-2">
        <button id="settings-toggle" aria-label="Open settings"
            class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 transition-all duration-300 focus:outline-none">
            <i class="fas fa-cog text-gray-600 dark:text-gray-300 transition-transform duration-300"></i>
        </button>
        <button 
[cite_start][cite: 334] id="dark-toggle" aria-label="Toggle dark mode"
            class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 transition-all duration-300 focus:outline-none">
            <i class="fas fa-sun text-yellow-500 hidden dark:block"></i>
            <i class="fas fa-moon text-gray-600 dark:text-gray-300 block dark:hidden"></i>
        </button>
    </div>

    <header class="mb-8 text-center">
        <h1 class="text-4xl md:text-5xl font-extrabold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent mb-3 animate-gradient">
  
[cite_start][cite: 335]           Work Time Tracker
        </h1>
        <p class="text-lg md:text-xl text-gray-700 dark:text-gray-300 font-light tracking-wide mb-2">
            <span class="inline-block">
                <i class="fas fa-clock text-blue-500 dark:text-blue-400 mr-2 animate-pulse"></i>
                Track Your Time
            
[cite_start][cite: 336] </span>
            <span class="mx-2">•</span>
            <span class="inline-block">
                <i class="fas fa-chart-line text-purple-500 dark:text-purple-400 mr-2 animate-pulse"></i>
                Monitor Earnings
            </span>
        </p>
        <p class="text-md md:text-lg font-semibold text-gray-800 dark:text-gray-200 bg-gradient-to-r 
[cite_start][cite: 337] from-blue-100 to-purple-100 dark:from-gray-900 dark:to-black py-1 px-3 rounded-full inline-block shadow-sm">
            By Interpreters for Interpreters
        </p>
    </header>

<div class="flex flex-col md:flex-row items-start justify-center gap-12 mb-8">
    <div class="tracker-container dark:bg-gray-800 rounded-xl shadow p-6 flex flex-col items-center w-full">
        <div class="flex flex-col items-center mb-2">
            <div class="bg-blue-100 dark:bg-blue-950 rounded-full w-16 h-16 flex items-center justify-center mb-3">
            
[cite_start][cite: 338]     <i class="fas fa-phone-volume text-3xl text-primary dark:text-blue-300"></i>
            </div>
            <h2 class="text-lg font-semibold mb-2 text-dark dark:text-gray-200">Call Controls</h2>
        </div>
        <div class="w-full mb-4">
    <label for="select-call-rate" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Select Rate</label>
    <select id="select-call-rate"
        class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200 bg-white dark:bg-gray-800">
    </select>
</div>
   
[cite_start][cite: 339]      <div class="flex flex-col gap-2 w-full">
            <button id="add-call-btn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 dark:bg-blue-500 dark:hover:bg-blue-600 transition w-full flex items-center justify-center gap-2">
                <i class="fas fa-plus"></i> Add Call
            </button>
            <button id="start-call-btn" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 dark:hover:bg-green-800 transition w-full flex items-center justify-center gap-2">
      
[cite_start][cite: 340]           <i class="fas fa-play"></i> Start Call
            </button>
            <button id="end-call-btn" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 dark:hover:bg-red-800 transition w-full flex items-center justify-center gap-2">
                <i class="fas fa-stop"></i> End Call
            </button>
        </div>
        
[cite_start][cite: 341] <div id="live-call-info" class="mt-4 w-full" style="display:none;">
            <div class="flex flex-col items-center bg-green-50 dark:bg-green-900 rounded-lg p-3 shadow-inner">
                <span class="text-green-700 dark:text-green-300 font-semibold text-sm mb-1">Ongoing Call</span>
                <span id="live-call-timer" class="font-mono text-xl text-green-900 dark:text-green-200 mb-1">00:00:00</span>
                <span id="live-call-earnings" class="font-mono text-lg text-green-800 dark:text-green-100">$0.00 earned</span>
          
[cite_start][cite: 342]   </div>
        </div>
    </div>

    <div class="flex flex-col w-full tracker-container">
        <div class="dark:bg-gray-800 rounded-xl shadow p-6 w-full mb-6">
            <div class="flex flex-col items-center mb-4">
                <div class="bg-purple-100 dark:bg-purple-950 rounded-full w-16 h-16 flex items-center justify-center mb-3">
                    <i class="fas fa-dollar-sign 
[cite_start][cite: 343] text-3xl text-purple-500 dark:text-purple-300"></i>
                </div>
                <h2 class="text-lg font-semibold text-dark dark:text-gray-200">Rates</h2>
            </div>
            <div id="rates-list" class="mb-4">
            </div>
            <button id="show-rate-add" class="w-full flex items-center justify-center gap-2 py-1">
     
[cite_start][cite: 344]            <i class="fas fa-plus"></i> Add Rate
            </button>
            <form id="rate-form" class="rate-edit-form" style="display: none;">
                <input type="text" id="rate-name" placeholder="Rate Name" maxlength="50"
                    class="w-full mb-2 px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
         
[cite_start][cite: 345]        <div class="flex items-center mb-2">
                    <span class="text-gray-600 dark:text-gray-300 mr-2">$</span>
                    <input type="number" id="rate-amount" placeholder="Amount" step="0.01" min="0.01" max="999999"
                        class="flex-1 px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
           
[cite_start][cite: 346]          <span class="text-gray-600 dark:text-gray-300 ml-2">/min</span>
                </div>
                <div class="flex gap-2">
                    <button type="submit"
                        class="flex-1 bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 transition">
  
[cite_start][cite: 347]                       Save
                    </button>
                    <button type="button" id="cancel-rate-add"
                        class="flex-1 bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-200 px-4 py-2 rounded hover:bg-gray-400 dark:hover:bg-gray-700 transition">
  
[cite_start][cite: 348]                       Cancel
                    </button>
                </div>
            </form>
        </div>

        <div class="dark:bg-gray-800 rounded-xl shadow p-6 w-full">
         
[cite_start][cite: 349]    <div class="flex flex-col items-center mb-4">
                <div class="bg-green-100 dark:bg-green-950 rounded-full w-16 h-16 flex items-center justify-center mb-3">
                    <i class="fas fa-bullseye text-3xl text-green-500 dark:text-green-300"></i>
                </div>
                <h2 class="text-lg font-semibold text-dark dark:text-gray-200">Daily Goal</h2>
      
[cite_start][cite: 350]       </div>
            <form id="goal-form" class="flex items-center gap-2">
                <div class="flex-1">
                    <div class="flex items-center">
                        <span class="text-gray-600 dark:text-gray-300 mr-2">$</span>
            
[cite_start][cite: 351]             <input type="number" id="goal-amount" placeholder="Amount" step="0.01" min="0" max="999999"
                            class="flex-1 px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                </div>
            
[cite_start][cite: 352]     <button type="submit" class="px-4 py-2 rounded transition-colors duration-200">
                    <i class="fas fa-save"></i>
                </button>
            </form>
            <div class="mt-4">
                <div class="relative pt-1">
         
[cite_start][cite: 353]            <div class="flex mb-2 items-center justify-between">
                        <div>
                            <span id="goal-progress-text"
                                
[cite_start][cite: 354] class="text-xs font-semibold inline-block text-green-600 dark:text-green-400">
                                0%
                            </span>
                        </div>
            
[cite_start][cite: 355]             <div class="text-right">
                            <span id="goal-amount-display"
                                class="text-xs font-semibold inline-block text-green-600 dark:text-green-400">
                      
[cite_start][cite: 356]           $0 / $0
                            </span>
                        </div>
                    </div>
                
[cite_start][cite: 357]     <div class="flex h-2 mb-4 overflow-hidden bg-green-200 rounded dark:bg-green-900">
                        <div id="goal-progress-bar"
                            class="flex flex-col justify-center overflow-hidden bg-green-500"
                            role="progressbar" style="width: 0%"></div>
  
[cite_start][cite: 358]                   </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden mb-8">
    <div class="p-6">
        <h2 class="text-2xl font-semibold text-gray-900 dark:text-gray-100 mb-4">
            <i class="fas fa-chart-bar text-purple-500 mr-2"></i>Call Statistics
 
[cite_start][cite: 359]        </h2>
        <div class="flex justify-between items-center mb-6">
            <div class="flex items-center gap-4">
                <input type="date" id="stats-date-picker"
                       class="px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200"
                />
 
[cite_start][cite: 360]                <button id="current-date-btn"
                        class="px-4 py-2 bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300 rounded-lg hover:bg-blue-200 dark:hover:bg-blue-800 transition-colors">
                    Current Date
                </button>
            </div>
  
[cite_start][cite: 361]       </div>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <div class="bg-blue-50 dark:bg-blue-900/40 p-4 rounded-lg">
                <h3 class="text-blue-700 dark:text-blue-300 font-medium mb-2">
                    <i class="fas fa-clock mr-2"></i>Average Call Duration
            
[cite_start][cite: 362]     </h3>
                <p id="avg-duration" class="text-2xl font-bold text-blue-800 dark:text-blue-200">00:00:00</p>
            </div>
            <div class="bg-green-50 dark:bg-green-900/40 p-4 rounded-lg">
                <h3 class="text-green-700 dark:text-green-300 font-medium mb-2">
                    <i class="fas fa-bullseye mr-2"></i>Goal Progress
   
[cite_start][cite: 363]              </h3>
                <p id="goal-estimate" class="text-2xl font-bold text-green-800 dark:text-green-200">-- mins to goal</p>
            </div>
            <div class="bg-yellow-50 dark:bg-yellow-900/40 p-4 rounded-lg">
                <h3 class="text-yellow-700 dark:text-yellow-300 font-medium mb-2">
               
[cite_start][cite: 364]      <i class="fas fa-chart-line mr-2"></i>Today's Earnings
                </h3>
                <p id="today-earnings" class="text-2xl font-bold text-yellow-800 dark:text-yellow-200">$0.00</p>
            </div>
        </div>

        <div id="monthly-earnings-cards" class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-purple-50 dark:bg-purple-900/40 p-4 rounded-lg">
     
[cite_start][cite: 365]            <h3 class="text-purple-700 dark:text-purple-300 font-medium mb-2">
                    <i class="fas fa-calendar-alt mr-2"></i>First Half of Month
                </h3>
                <p class="text-lg text-purple-800 dark:text-purple-200 font-bold">
                    <span id="first-half-earnings">$0.00</span>
  
[cite_start][cite: 366]               </p>
            </div>
            <div class="bg-purple-50 dark:bg-purple-900/40 p-4 rounded-lg">
                <h3 class="text-purple-700 dark:text-purple-300 font-medium mb-2">
                    <i class="fas fa-calendar-alt mr-2"></i>Second Half of Month
            
[cite_start][cite: 367]     </h3>
                <p class="text-lg text-purple-800 dark:text-purple-200 font-bold">
                    <span id="second-half-earnings">$0.00</span>
                </p>
            </div>
            <div class="bg-purple-50 dark:bg-purple-900/40 p-4 rounded-lg">
           
[cite_start][cite: 368]      <h3 class="text-purple-700 dark:text-purple-300 font-medium mb-2">
                    <i class="fas fa-dollar-sign mr-2"></i>Total in Current Month
                </h3>
                <p class="text-lg text-purple-800 dark:text-purple-200 font-bold">
                    <span id="monthly-total-earnings">$0.00</span>
        
[cite_start][cite: 369]         </p>
            </div>
        </div>

        <div id="payment-cycle-earnings-cards" class="grid grid-cols-1 md:grid-cols-3 gap-4 hidden">
            <div class="bg-purple-50 dark:bg-purple-900/40 p-4 rounded-lg">
                <h3 class="text-purple-700 dark:text-purple-300 font-medium mb-2">
                    <i class="fas 
[cite_start][cite: 370] fa-money-bill-wave mr-2"></i>Current Cycle Earnings
                </h3>
                <p id="cycle-earnings" class="text-2xl font-bold text-purple-800 dark:text-purple-200">
                    $0.00
                </p>
            </div>
            
[cite_start][cite: 371] <div class="bg-purple-50 dark:bg-purple-900/40 p-4 rounded-lg">
                <h3 class="text-purple-700 dark:text-purple-300 font-medium mb-2">
                    <i class="fas fa-calendar-check mr-2"></i>Cycle Progress
                </h3>
                <div class="text-sm text-gray-700 dark:text-gray-300">
                 
[cite_start][cite: 372]    <p class="mb-1">
                        <i class="fas fa-calendar-day mr-2"></i>
                        Start: <span id="cycle-start-date">N/A</span>
                    </p>
                    <p class="mb-1">
  
[cite_start][cite: 373]                       <i class="fas fa-calendar-day mr-2"></i>
                        End: <span id="cycle-end-date">N/A</span>
                    </p>
                    <p>
         
[cite_start][cite: 374]                <i class="fas fa-calendar-check mr-2"></i>
                        Days Left: <span id="days-until-end">N/A</span>
                    </p>
                </div>
            </div>
       
[cite_start][cite: 375]      <div class="bg-purple-50 dark:bg-purple-900/40 p-4 rounded-lg">
                <h3 class="text-purple-700 dark:text-purple-300 font-medium mb-2">
                    <i class="fas fa-clock mr-2"></i>Pay Day Countdown
                </h3>
                <div class="text-sm text-gray-700 dark:text-gray-300">
           
[cite_start][cite: 376]          <p class="mb-1">
                        <i class="fas fa-calendar-dollar mr-2"></i>
                        Pay Date: <span id="pay-date">N/A</span>
                    </p>
                
[cite_start][cite: 377]     <p>
                        <i class="fas fa-clock mr-2"></i>
                        Days to Pay: <span id="days-until-pay">N/A</span>
                    </p>
                </div>
     
[cite_start][cite: 378]        </div>
        </div>
    </div>
</div>

<div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden mb-8">
    <div class="p-6">
        <div class="flex flex-col md:flex-row items-center justify-between gap-4 mb-6">
            <h2 class="text-2xl font-semibold text-gray-900 dark:text-gray-100">
                <i class="fas fa-history text-blue-500 mr-2"></i>Call Log
            </h2>
      
[cite_start][cite: 379]       <div class="flex flex-wrap items-center gap-4">
                <div class="flex items-center gap-2">
                    <span class="text-gray-600 dark:text-gray-400">Total Time:</span>
                    <span id="total-minutes" class="font-mono text-lg">00:00:00</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-gray-600 dark:text-gray-400">Total Earnings:</span>
                    <span id="total-earnings" class="font-mono text-lg">$0.00</span>
                </div>
            </div>
        </div>
        <div class="overflow-x-auto">
            <table class="call-log-table w-full">
                <thead>
                    <tr class="text-left">
                        <th class="font-semibold">Date</th>
                        <th class="font-semibold">Duration</th>
                        <th class="font-semibold">Rate</th>
                        <th class="font-semibold">Earned</th>
                        <th class="font-semibold pl-4">Actions</th>
                    </tr>
                </thead>
                <tbody id="call-log">
                </tbody>
                <tfoot>
                    <tr class="bg-gray-50 dark:bg-gray-800">
                        <td colspan="5" class="py-4 text-center text-gray-500 dark:text-gray-400">
                            End of call log
                        </td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>

<div id="call-modal" style="display: none;"
[cite_start][cite: 380] role="dialog" aria-labelledby="modal-title" aria-modal="true" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100" id="modal-title">Add Call</h3>
            <button id="close-modal" aria-label="Close modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="call-form">
            <div class="mb-4">
                <label for="call-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Date & Time</label>
                <input type="datetime-local" id="call-date" required
                    class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200">
            </div>
            <div class="mb-4">
                <label for="call-duration-hours" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Duration (HH:MM:SS)</label>
                <div class="flex gap-2">
                    <input type="number" id="call-duration-hours" min="0" max="24" placeholder="HH" aria-label="Hours"
                        class="w-full px-3 py-2 border rounded-lg 
[cite_start][cite: 381] focus:outline-none focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200">
                    <input type="number" id="call-duration-minutes" min="0" max="59" placeholder="MM" aria-label="Minutes"
                        class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200">
                    <input type="number" id="call-duration-seconds" min="0" max="59" placeholder="SS" aria-label="Seconds"
                        class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200">
                </div>
            </div>
            <div class="mb-6">
                <label for="call-rate" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Rate</label>
                <select id="call-rate"
                    class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200">
                </select>
            </div>
            <div class="flex justify-end gap-3">
                <button type="button" id="cancel-call"
                    class="px-4 py-2 text-gray-700 bg-gray-200 rounded hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600">
                    Cancel
                </button>
                <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                    Save
                </button>
            </div>
        </form>
    </div>
</div>
<div id="settings-modal" style="display: 
[cite_start][cite: 382] none;" role="dialog" aria-labelledby="settings-modal-title" aria-modal="true" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100" id="settings-modal-title">Settings</h3>
            <button id="close-settings-modal" aria-label="Close settings" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="space-y-4">
            <div class="border-b border-gray-200 dark:border-gray-700 pb-4">
                <h4 class="text-lg font-medium text-gray-900 dark:text-gray-100 mb-3">Data Management</h4>
                <div class="flex flex-col gap-2">
                    <button id="export-data" class="flex items-center gap-2 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors">
                        <i class="fas fa-download"></i> Export Data
                    </button>
                    <label for="import-file" class="flex items-center gap-2 px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 transition-colors cursor-pointer">
                        <i class="fas fa-upload"></i> Import Data
                    </label>
[cite_start][cite: 383]                     <input type="file" id="import-file" accept=".json" class="hidden">
                </div>
            </div>
            <div class="border-b border-gray-200 dark:border-gray-700 pb-4">
                <h4 class="text-lg font-medium text-gray-900 dark:text-gray-100 mb-3">Storage</h4>
                <div class="mb-2">
                    <div class="flex justify-between text-sm text-gray-600 dark:text-gray-400 mb-1">
                        <span>Storage Used</span>
                        <span id="storage-used">Calculating...</span>
                    </div>
                    <div class="h-2 bg-gray-200 dark:bg-gray-700 rounded">
                        <div id="storage-bar" class="h-2 bg-blue-500 rounded" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            <div class="border-b border-gray-200 dark:border-gray-700 pb-4">
                <div class="flex justify-between items-center mb-3">
                    <h4 class="text-lg font-medium text-gray-900 dark:text-gray-100">Payment Cycles</h4>
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="payment-cycles-toggle" class="sr-only peer">
                        <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                        <span 
[cite_start][cite: 384] class="ml-3 text-sm font-medium text-gray-900 dark:text-gray-300">Enable Payment Cycles</span>
                    </label>
                </div>
                <div id="payment-cycles-config" class="hidden">
                    <div class="mb-3">
                        <button id="add-cycle" class="flex items-center gap-2 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors">
                            <i class="fas fa-plus"></i> Add Payment Cycle
                        </button>
                    </div>
                    <div class="max-h-48 overflow-y-auto">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                            <thead class="bg-gray-50 dark:bg-gray-800">
                                <tr>
                                    <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Start Date</th>
                                    <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">End Date</th>
                                    <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Pay Date</th>
                                    <th class="px-2 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="cycle-table-body" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div>
                <button id="reset-data"
                    class="w-full px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition-colors flex items-center justify-center gap-2">
                    <i class="fas fa-trash-alt"></i> Delete All Data
                </button>
            </div>
        </div>
    </div>
</div>

<footer class="mt-8 text-center text-sm text-gray-500 dark:text-gray-400">
    <p>
        <button id="privacy-policy" class="hover:underline mx-1">Privacy Policy</button> |
        <button id="terms-of-service" class="hover:underline mx-1">Terms of Service</button>
    </p>
</footer>
</div>

<script>
    // Global Constants
    const STORAGE_KEY = 'workTimeTrackerData';
    const MAX_STORAGE_MB = 5; // 5MB limit
    
    // Global Elements
    const addCallBtn = document.getElementById('add-call-btn');
    const startCallBtn = document.getElementById('start-call-btn');
    const endCallBtn = document.getElementById('end-call-btn');
    const selectCallRate = document.getElementById('select-call-rate');
    const liveCallInfo = document.getElementById('live-call-info');
    const liveCallTimer = document.getElementById('live-call-timer');
    const liveCallEarnings = document.getElementById('live-call-earnings');
    const callLogBody = document.getElementById('call-log');
    const totalMinutesEl = document.getElementById('total-minutes');
    const totalEarningsEl = document.getElementById('total-earnings');
    const ratesList = document.getElementById('rates-list');
    const rateForm = document.getElementById('rate-form');
    const rateNameInput = document.getElementById('rate-name');
    const rateAmountInput = document.getElementById('rate-amount');
    const showRateAddBtn = document.getElementById('show-rate-add');
    const cancelRateAddBtn = document.getElementById('cancel-rate-add');
    const goalForm = document.getElementById('goal-form');
    const goalAmountInput = document.getElementById('goal-amount');
    const goalProgressText = document.getElementById('goal-progress-text');
    const goalAmountDisplay = document.getElementById('goal-amount-display');
    const goalProgressBar = document.getElementById('goal-progress-bar');
    const statsDatePicker = document.getElementById('stats-date-picker');
    const avgDurationEl = document.getElementById('avg-duration');
    const goalEstimateEl = document.getElementById('goal-estimate');
    const todayEarningsEl = document.getElementById('today-earnings');
    const firstHalfEarningsEl = document.getElementById('first-half-earnings');
    const secondHalfEarningsEl = document.getElementById('second-half-earnings');
    const monthlyTotalEarningsEl = document.getElementById('monthly-total-earnings');
    const darkToggle = document.getElementById('dark-toggle');
    const settingsToggle = document.getElementById('settings-toggle');
    const callModal = document.getElementById('call-modal');
    const settingsModal = document.getElementById('settings-modal');
    const closeModalBtn = document.getElementById('close-modal');
    const closeSettingsModalBtn = document.getElementById('close-settings-modal');
    const callForm = document.getElementById('call-form');
    const callDateInput = document.getElementById('call-date');
    const callDurationHoursInput = document.getElementById('call-duration-hours');
    const callDurationMinutesInput = document.getElementById('call-duration-minutes');
    const callDurationSecondsInput = document.getElementById('call-duration-seconds');
    const callRateSelect = document.getElementById('call-rate');
    const cancelCallBtn = document.getElementById('cancel-call');
    const exportBtn = document.getElementById('export-data');
    const importInput = document.getElementById('import-file');
    const storageUsedEl = document.getElementById('storage-used');
    const storageBarEl = document.getElementById('storage-bar');
    const resetDataBtn = document.getElementById('reset-data');
    const paymentCyclesToggle = document.getElementById('payment-cycles-toggle');
    const paymentCyclesConfig = document.getElementById('payment-cycles-config');
    const monthlyEarningsCards = document.getElementById('monthly-earnings-cards');
    const paymentCycleEarningsCards = document.getElementById('payment-cycle-earnings-cards');
    const cycleEarningsEl = document.getElementById('cycle-earnings');
    const cycleStartDateEl = document.getElementById('cycle-start-date');
    const cycleEndDateEl = document.getElementById('cycle-end-date');
    const daysUntilEndEl = document.getElementById('days-until-end');
    const payDateEl = document.getElementById('pay-date');
    const daysUntilPayEl = document.getElementById('days-until-pay');
    const addCycleBtn = document.getElementById('add-cycle');
    const cycleTableBody = document.getElementById('cycle-table-body');
    const currentDateBtn = document.getElementById('current-date-btn');


    // State variables
    let calls = [];
    let rates = [];
    let dailyGoal = 0;
    let liveCall = null;
    let timerInterval = null;
    let editCallIndex = -1;
    let editRateId = null;
    let activeTimers = new Set();
    let paymentCycles = [];

    // Helper functions
    function loadData() {
        const data = JSON.parse(localStorage.getItem(STORAGE_KEY)) || { calls: [], rates: [], dailyGoal: 0, paymentCycles: [] };
        calls = data.calls || [];
        rates = data.rates || [];
        dailyGoal = data.dailyGoal || 0;
        paymentCycles = data.paymentCycles || [];
    }

    function saveData() {
        const data = { calls, rates, dailyGoal, paymentCycles };
        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            updateStorageInfo();
        } catch (e) {
            console.error("Failed to save data to localStorage:", e);
            alert("Warning: Could not save data. Your browser storage is full or there's an issue with localStorage.");
        }
    }

    function formatTime(totalSeconds) {
        if (isNaN(totalSeconds) || totalSeconds < 0) return '00:00:00';
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = Math.floor(totalSeconds % 60);
        return [hours, minutes, seconds].map(v => v < 10 ? "0" + v : v).join(":");
    }

    function formatCurrency(amount) {
        if (isNaN(amount)) return '$0.00';
        return `$${amount.toFixed(2)}`;
    }

    function calculateEarnings(durationMinutes, ratePerMinute) {
        return durationMinutes * ratePerMinute;
    }

    function getRateById(id) {
        return rates.find(r => r.id === id);
    }

    function getToday() {
        return new Date().toISOString().split('T')[0];
    }

    function isSameDay(date1, date2) {
        return new Date(date1).toDateString() === new Date(date2).toDateString();
    }

    // Modal Handlers
    function showModal(modal) {
        if (modal) {
            modal.style.display = 'flex';
            document.body.classList.add('overflow-hidden');
            if (modal === callModal) {
                callDateInput.focus();
            } else if (modal === settingsModal) {
                // Focus on the first interactive element if needed
            }
        }
    }

    function hideModal(modal) {
        if (modal) {
            modal.style.display = 'none';
            document.body.classList.remove('overflow-hidden');
            // Reset modal state
            if (modal === callModal) {
                callForm.reset();
                editCallIndex = -1;
                document.getElementById('modal-title').textContent = 'Add Call';
            } else if (modal === settingsModal) {
                // Settings modal specific cleanup
            }
        }
    }

    function handleModalKeyboard(e) {
        if (e.key === 'Escape') {
            hideModal(callModal);
        }
    }

    function handleSettingsKeyboard(e) {
        if (e.key === 'Escape') {
            hideModal(settingsModal);
        }
    }

    // UI Rendering
    function displayCalls() {
        const today = statsDatePicker.value || getToday();
        const filteredCalls = calls.filter(call => isSameDay(call.date, today));
        callLogBody.innerHTML = '';
        if (filteredCalls.length === 0) {
            callLogBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-500 dark:text-gray-400">No calls logged for this date.</td></tr>`;
        } else {
            filteredCalls.forEach((call, index) => {
                const rate = getRateById(call.rateId);
                const earned = calculateEarnings(call.durationMinutes, rate.amount);
                const row = document.createElement('tr');
                row.classList.add('hover:bg-gray-100', 'dark:hover:bg-gray-700', 'transition-colors');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-gray-100">${new Date(call.date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">${formatTime(call.durationMinutes * 60)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">
                        <span class="tag">${rate ? rate.name : 'N/A'}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">${formatCurrency(earned)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="text-blue-600 dark:text-blue-400 hover:text-blue-900 dark:hover:text-blue-300 mr-2" onclick="editCall(${call.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="text-red-600 dark:text-red-400 hover:text-red-900 dark:hover:text-red-300" onclick="deleteCall(${call.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                callLogBody.appendChild(row);
            });
        }
    }

    function displayRates() {
        ratesList.innerHTML = '';
        selectCallRate.innerHTML = '<option value="">Select a rate...</option>';
        callRateSelect.innerHTML = '';
        if (rates.length === 0) {
            ratesList.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-sm">No rates added yet. Click "Add Rate" to get started!</p>';
        }
        rates.forEach(rate => {
            // Display for rates card
            const rateItem = document.createElement('div');
            rateItem.classList.add('rates-list-item');
            rateItem.innerHTML = `
                <div class="flex-grow flex items-center">
                    <span class="font-medium text-gray-900 dark:text-gray-100 mr-2">${rate.name}:</span>
                    <span class="text-gray-600 dark:text-gray-300">${formatCurrency(rate.amount)}/min</span>
                </div>
                <div>
                    <button class="edit-rate-btn" onclick="editRate(${rate.id})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="bg-red-500 text-white px-2 py-1 rounded-full text-xs hover:bg-red-600 transition" onclick="deleteRate(${rate.id})">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            `;
            ratesList.appendChild(rateItem);

            // Populate select menus
            const option = document.createElement('option');
            option.value = rate.id;
            option.textContent = `${rate.name} (${formatCurrency(rate.amount)}/min)`;
            selectCallRate.appendChild(option.cloneNode(true));
            callRateSelect.appendChild(option);
        });
    }

    function updateStatistics() {
        const today = statsDatePicker.value || getToday();
        const selectedDateCalls = calls.filter(call => isSameDay(call.date, today));

        const totalMinutes = selectedDateCalls.reduce((sum, call) => sum + call.durationMinutes, 0);
        const totalEarnings = selectedDateCalls.reduce((sum, call) => {
            const rate = getRateById(call.rateId);
            return sum + (rate ? calculateEarnings(call.durationMinutes, rate.amount) : 0);
        }, 0);

        todayEarningsEl.textContent = formatCurrency(totalEarnings);
        totalMinutesEl.textContent = formatTime(totalMinutes * 60);
        totalEarningsEl.textContent = formatCurrency(totalEarnings);
        
        // Average duration
        const avgDuration = selectedDateCalls.length > 0 ? totalMinutes / selectedDateCalls.length : 0;
        avgDurationEl.textContent = formatTime(avgDuration * 60);

        // Daily goal progress
        const goal = dailyGoal;
        goalAmountDisplay.textContent = `${formatCurrency(totalEarnings)} / ${formatCurrency(goal)}`;
        let progressPercent = (goal > 0) ? Math.min(100, (totalEarnings / goal) * 100) : 0;
        goalProgressBar.style.width = `${progressPercent}%`;
        goalProgressText.textContent = `${progressPercent.toFixed(0)}%`;
        if (progressPercent >= 100) {
            goalProgressText.textContent = 'Goal Met! 🎉';
            goalProgressText.classList.add('animate-beat');
        } else {
            goalProgressText.classList.remove('animate-beat');
        }
        
        // Goal estimate
        if (goal > 0 && totalEarnings < goal) {
            const remaining = goal - totalEarnings;
            const ratesSorted = rates.sort((a, b) => b.amount - a.amount);
            if (ratesSorted.length > 0) {
                const highestRate = ratesSorted[0];
                const minutesToGoal = remaining / highestRate.amount;
                goalEstimateEl.textContent = `${minutesToGoal.toFixed(0)} mins to goal`;
            } else {
                goalEstimateEl.textContent = `-- mins to goal`;
            }
        } else {
            goalEstimateEl.textContent = `Goal Met!`;
        }
        
        // Monthly earnings stats
        const currentMonth = new Date(today).getMonth();
        const firstHalfEarnings = calls.reduce((sum, call) => {
            const callDate = new Date(call.date);
            const rate = getRateById(call.rateId);
            if (callDate.getMonth() === currentMonth && callDate.getDate() <= 15) {
                return sum + (rate ? calculateEarnings(call.durationMinutes, rate.amount) : 0);
            }
            return sum;
        }, 0);
        const secondHalfEarnings = calls.reduce((sum, call) => {
            const callDate = new Date(call.date);
            const rate = getRateById(call.rateId);
            if (callDate.getMonth() === currentMonth && callDate.getDate() > 15) {
                return sum + (rate ? calculateEarnings(call.durationMinutes, rate.amount) : 0);
            }
            return sum;
        }, 0);
        const monthlyTotal = firstHalfEarnings + secondHalfEarnings;
        firstHalfEarningsEl.textContent = formatCurrency(firstHalfEarnings);
        secondHalfEarningsEl.textContent = formatCurrency(secondHalfEarnings);
        monthlyTotalEarningsEl.textContent = formatCurrency(monthlyTotal);

        // Payment cycle stats
        const cycle = findCurrentCycle(today);
        if (cycle) {
            const cycleCalls = calls.filter(call => {
                const callDate = new Date(call.date);
                return callDate >= new Date(cycle.startDate) && callDate <= new Date(cycle.endDate);
            });
            const cycleTotalEarnings = cycleCalls.reduce((sum, call) => {
                const rate = getRateById(call.rateId);
                return sum + (rate ? calculateEarnings(call.durationMinutes, rate.amount) : 0);
            }, 0);
            cycleEarningsEl.textContent = formatCurrency(cycleTotalEarnings);
            cycleStartDateEl.textContent = new Date(cycle.startDate).toLocaleDateString();
            cycleEndDateEl.textContent = new Date(cycle.endDate).toLocaleDateString();
            
            const todayDate = new Date();
            const endDate = new Date(cycle.endDate);
            const daysLeft = Math.ceil((endDate - todayDate) / (1000 * 60 * 60 * 24));
            daysUntilEndEl.textContent = daysLeft >= 0 ? daysLeft : 'Cycle Ended';

            if (cycle.payDate) {
                const payDate = new Date(cycle.payDate);
                const daysToPay = Math.ceil((payDate - todayDate) / (1000 * 60 * 60 * 24));
                payDateEl.textContent = payDate.toLocaleDateString();
                daysUntilPayEl.textContent = daysToPay >= 0 ? daysToPay : 'Paid!';
            } else {
                payDateEl.textContent = 'N/A';
                daysUntilPayEl.textContent = 'N/A';
            }
        }
    }

    function renderPaymentCycles() {
        cycleTableBody.innerHTML = '';
        paymentCycles.forEach((cycle, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="px-2 py-2 text-sm text-gray-500 dark:text-gray-300">${cycle.startDate}</td>
                <td class="px-2 py-2 text-sm text-gray-500 dark:text-gray-300">${cycle.endDate}</td>
                <td class="px-2 py-2 text-sm text-gray-500 dark:text-gray-300">${cycle.payDate || 'N/A'}</td>
                <td class="px-2 py-2 text-right text-sm font-medium">
                    <button class="text-red-600 dark:text-red-400 hover:text-red-900 dark:hover:text-red-300" onclick="deleteCycle(${index})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            cycleTableBody.appendChild(row);
        });
    }

    function findCurrentCycle(date) {
        const d = new Date(date);
        return paymentCycles.find(cycle => {
            const start = new Date(cycle.startDate);
            const end = new Date(cycle.endDate);
            return d >= start && d <= end;
        });
    }

    // Data Management
    function updateStorageInfo() {
        const dataSizeKB = new TextEncoder().encode(localStorage.getItem(STORAGE_KEY)).length / 1024;
        const totalSizeKB = MAX_STORAGE_MB * 1024;
        const usagePercent = (dataSizeKB / totalSizeKB) * 100;
        storageUsedEl.textContent = `${dataSizeKB.toFixed(2)} KB`;
        storageBarEl.style.width = `${Math.min(100, usagePercent).toFixed(2)}%`;
        if (usagePercent > 80) {
            storageBarEl.classList.add('bg-red-500');
            storageBarEl.classList.remove('bg-blue-500');
        } else {
            storageBarEl.classList.add('bg-blue-500');
            storageBarEl.classList.remove('bg-red-500');
        }
    }

    // Actions
    function startLiveCall() {
        if (liveCall || selectCallRate.value === "") {
            alert('Please select a rate to start a call.');
            return;
        }

        const rateId = selectCallRate.value;
        liveCall = {
            rateId: rateId,
            startTime: Date.now(),
            totalDuration: 0
        };

        const rate = getRateById(rateId);
        if (!rate) {
            alert('Selected rate not found.');
            liveCall = null;
            return;
        }

        liveCallInfo.style.display = 'flex';
        startCallBtn.disabled = true;
        endCallBtn.disabled = false;
        selectCallRate.disabled = true;

        timerInterval = setInterval(() => {
            if (liveCall) {
                const durationSeconds = Math.floor((Date.now() - liveCall.startTime) / 1000);
                const earned = calculateEarnings(durationSeconds / 60, rate.amount);
                liveCallTimer.textContent = formatTime(durationSeconds);
                liveCallEarnings.textContent = formatCurrency(earned);
                liveCall.totalDuration = durationSeconds;
            }
        }, 1000);
        activeTimers.add(timerInterval);
    }

    function endLiveCall() {
        if (!liveCall) return;

        clearInterval(timerInterval);
        activeTimers.delete(timerInterval);

        const durationMinutes = liveCall.totalDuration / 60;
        const newCall = {
            id: Date.now(),
            date: new Date().toISOString(),
            durationMinutes: durationMinutes,
            rateId: liveCall.rateId
        };
        calls.push(newCall);
        saveData();
        updateStatistics();
        displayCalls();

        liveCall = null;
        liveCallInfo.style.display = 'none';
        startCallBtn.disabled = false;
        endCallBtn.disabled = true;
        selectCallRate.disabled = false;
        liveCallTimer.textContent = '00:00:00';
        liveCallEarnings.textContent = '$0.00 earned';
        alert(`Call logged! You earned ${formatCurrency(calculateEarnings(durationMinutes, getRateById(newCall.rateId).amount))}`);
    }

    function addCall() {
        showModal(callModal);
        document.getElementById('modal-title').textContent = 'Add Call';
        callDateInput.value = new Date().toISOString().slice(0, 16);
        editCallIndex = -1;
    }

    function editCall(id) {
        const index = calls.findIndex(call => call.id === id);
        if (index === -1) return;
        editCallIndex = index;
        const call = calls[index];

        document.getElementById('modal-title').textContent = 'Edit Call';
        callDateInput.value = new Date(call.date).toISOString().slice(0, 16);
        
        const totalSeconds = call.durationMinutes * 60;
        callDurationHoursInput.value = Math.floor(totalSeconds / 3600);
        callDurationMinutesInput.value = Math.floor((totalSeconds % 3600) / 60);
        callDurationSecondsInput.value = Math.floor(totalSeconds % 60);
        
        callRateSelect.value = call.rateId;
        showModal(callModal);
    }

    function saveCall() {
        const date = callDateInput.value;
        const hours = parseInt(callDurationHoursInput.value) || 0;
        const minutes = parseInt(callDurationMinutesInput.value) || 0;
        const seconds = parseInt(callDurationSecondsInput.value) || 0;
        const rateId = callRateSelect.value;
        const rate = getRateById(rateId);

        if (!date || !rate) {
            alert('Please fill out all fields.');
            return;
        }

        const durationMinutes = (hours * 60) + minutes + (seconds / 60);
        if (durationMinutes <= 0) {
            alert('Duration must be greater than zero.');
            return;
        }

        if (editCallIndex !== -1) {
            // Update existing call
            calls[editCallIndex].date = date;
            calls[editCallIndex].durationMinutes = durationMinutes;
            calls[editCallIndex].rateId = rateId;
        } else {
            // Add new call
            const newCall = {
                id: Date.now(),
                date,
                durationMinutes,
                rateId
            };
            calls.push(newCall);
        }

        saveData();
        displayCalls();
        updateStatistics();
        hideModal(callModal);
    }

    function deleteCall(id) {
        if (confirm('Are you sure you want to delete this call?')) {
            calls = calls.filter(call => call.id !== id);
            saveData();
            displayCalls();
            updateStatistics();
        }
    }

    function addRate() {
        const name = rateNameInput.value.trim();
        const amount = parseFloat(rateAmountInput.value);

        if (!name || isNaN(amount) || amount <= 0) {
            alert('Please enter a valid rate name and amount.');
            return;
        }

        if (editRateId) {
            const rateIndex = rates.findIndex(r => r.id === editRateId);
            if (rateIndex !== -1) {
                rates[rateIndex].name = name;
                rates[rateIndex].amount = amount;
            }
        } else {
            const newRate = {
                id: Date.now(),
                name,
                amount
            };
            rates.push(newRate);
        }

        saveData();
        displayRates();
        updateStatistics();
        rateForm.reset();
        rateForm.style.display = 'none';
        showRateAddBtn.style.display = 'flex';
        editRateId = null;
    }

    function editRate(id) {
        const rateToEdit = rates.find(r => r.id === id);
        if (rateToEdit) {
            rateNameInput.value = rateToEdit.name;
            rateAmountInput.value = rateToEdit.amount;
            rateForm.style.display = 'block';
            showRateAddBtn.style.display = 'none';
            editRateId = id;
        }
    }

    function deleteRate(id) {
        if (confirm('Are you sure you want to delete this rate? All calls associated with this rate will be unaffected.')) {
            rates = rates.filter(rate => rate.id !== id);
            saveData();
            displayRates();
            updateStatistics();
        }
    }

    function setDailyGoal() {
        const goal = parseFloat(goalAmountInput.value);
        if (isNaN(goal) || goal < 0) {
            alert('Please enter a valid goal amount.');
            return;
        }
        dailyGoal = goal;
        saveData();
        updateStatistics();
        alert('Daily goal saved!');
    }

    function handleImport(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(event) {
            try {
                const importedData = JSON.parse(event.target.result);
                if (importedData.calls && importedData.rates) {
                    // Simple merge strategy: append new data
                    const newCalls = importedData.calls.filter(impCall => !calls.some(appCall => appCall.id === impCall.id));
                    const newRates = importedData.rates.filter(impRate => !rates.some(appRate => appRate.id === impRate.id));
                    
                    calls = [...calls, ...newCalls];
                    rates = [...rates, ...newRates];

                    if (importedData.dailyGoal !== undefined) dailyGoal = importedData.dailyGoal;
                    if (importedData.paymentCycles) paymentCycles = importedData.paymentCycles;
                    
                    saveData();
                    location.reload(); // Reload to refresh all displays
                } else {
                    alert("Invalid file format. Please import a valid Work Time Tracker JSON file.");
                }
            } catch (error) {
                alert("Error importing file. Please check the file format.");
                console.error("Import error:", error);
            }
        };
        reader.readAsText(file);
    }
    
    function resetData() {
        if (confirm("Are you sure you want to delete all your data? This action cannot be undone.")) {
            localStorage.removeItem(STORAGE_KEY);
            calls = [];
            rates = [];
            dailyGoal = 0;
            paymentCycles = [];
            liveCall = null;
            location.reload();
        }
    }

    function addPaymentCycle() {
        const startDate = prompt("Enter the start date (YYYY-MM-DD):");
        const endDate = prompt("Enter the end date (YYYY-MM-DD):");
        const payDate = prompt("Enter the pay date (YYYY-MM-DD, optional):");

        if (!startDate || !endDate) {
            alert('Start and end dates are required.');
            return;
        }

        if (paymentCycles.some(cycle => 
            (new Date(startDate) >= new Date(cycle.startDate) && new Date(startDate) <= new Date(cycle.endDate)) ||
            (new Date(endDate) >= new Date(cycle.startDate) && new Date(endDate) <= new Date(cycle.endDate))
        )) {
            alert('New cycle overlaps with an existing cycle.');
            return;
        }

        paymentCycles.push({ startDate, endDate, payDate });
        paymentCycles.sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
        saveData();
        renderPaymentCycles();
        updateStatistics();
    }

    function deleteCycle(index) {
        if (confirm('Are you sure you want to delete this payment cycle?')) {
            paymentCycles.splice(index, 1);
            saveData();
            renderPaymentCycles();
            updateStatistics();
        }
    }

    // Event Listeners
    document.addEventListener('DOMContentLoaded', () => {
        loadData();
        displayRates();
        displayCalls();
        updateStatistics();
        updateStorageInfo();
        renderPaymentCycles();
        
        goalAmountInput.value = dailyGoal;
        statsDatePicker.value = getToday();

        addCallBtn.addEventListener('click', addCall);
        startCallBtn.addEventListener('click', startLiveCall);
        endCallBtn.addEventListener('click', endLiveCall);

        rateForm.addEventListener('submit', (e) => {
            e.preventDefault();
            addRate();
        });

        showRateAddBtn.addEventListener('click', () => {
            rateForm.style.display = 'block';
            showRateAddBtn.style.display = 'none';
            rateNameInput.focus();
        });

        cancelRateAddBtn.addEventListener('click', () => {
            rateForm.style.display = 'none';
            showRateAddBtn.style.display = 'flex';
            rateForm.reset();
            editRateId = null;
        });

        goalForm.addEventListener('submit', (e) => {
            e.preventDefault();
            setDailyGoal();
        });

        statsDatePicker.addEventListener('change', () => {
            displayCalls();
            updateStatistics();
        });

        currentDateBtn.addEventListener('click', () => {
            statsDatePicker.value = getToday();
            displayCalls();
            updateStatistics();
        });
        
        darkToggle.addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
        });
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }

        settingsToggle.addEventListener('click', () => showModal(settingsModal));
        closeModalBtn.addEventListener('click', () => hideModal(callModal));
        closeSettingsModalBtn.addEventListener('click', () => hideModal(settingsModal));
        cancelCallBtn.addEventListener('click', () => hideModal(callModal));

        callForm.addEventListener('submit', (e) => {
            e.preventDefault();
            saveCall();
        });

        exportBtn.addEventListener('click', () => {
            const dataStr = JSON.stringify({ calls, rates, dailyGoal, paymentCycles }, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'work_time_tracker_data.json';
            a.click();
            URL.revokeObjectURL(url);
        });

        importInput.addEventListener('change', handleImport);
        resetDataBtn.addEventListener('click', resetData);

        paymentCyclesToggle.addEventListener('change', (e) => {
            const isChecked = e.target.checked;
            paymentCyclesConfig.classList.toggle('hidden', !isChecked);
            monthlyEarningsCards.classList.toggle('hidden', isChecked);
            paymentCycleEarningsCards.classList.toggle('hidden', !isChecked);
            updateStatistics();
            if (isChecked) {
                document.getElementById('stats-date-picker').value = getToday();
                displayCalls();
            }
        });
        
        // Initial state for payment cycles
        if (paymentCycles.length > 0) {
            paymentCyclesToggle.checked = true;
            paymentCyclesConfig.classList.remove('hidden');
            monthlyEarningsCards.classList.add('hidden');
            paymentCycleEarningsCards.classList.remove('hidden');
        }

        addCycleBtn.addEventListener('click', addPaymentCycle);

        // Global Event Listeners
        // This consolidates the duplicated keydown listeners.
        document.addEventListener('keydown', (e) => {
            if (callModal && callModal.style.display === 'flex') {
                handleModalKeyboard(e);
            } else if (settingsModal && settingsModal.style.display === 'flex') {
                handleSettingsKeyboard(e);
            }
        });
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            activeTimers.forEach(timerId => clearInterval(timerId));
            activeTimers.clear();
        });

        // Footer button handlers
        document.getElementById('privacy-policy')?.addEventListener('click', () => {
            alert('Privacy Policy: This app stores all data locally in your browser. No data is sent to external servers.');
        });

        document.getElementById('terms-of-service')?.addEventListener('click', () => {
            alert('Terms of Service: This app is provided "as is" without any warranties. Use at your own discretion.');
        });
        
        // Initialize displays and add event listeners
        displayRates();
        displayCalls();
        updateStatistics();
        updateStorageInfo();
        renderPaymentCycles();
    });
</script>
</body>
</html>
