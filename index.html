<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Work Time Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Drag and Drop Styles */
        .draggable-card {
            cursor: grab;
            user-select: none;
            touch-action: none;
            transition: transform 0.1s ease, box-shadow 0.2s ease;
        }
        .draggable-card.dragging {
            cursor: grabbing;
            transform: scale(1.02);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            z-index: 10;
        }
        .draggable-card.placeholder {
            opacity: 0.5;
            background: #f0f0f0;
            border: 2px dashed #ccc;
        }
        html.dark .draggable-card.placeholder {
            background: #2d3748;
            border-color: #4a5568;
        }

        @keyframes heartbeat {
            0% { transform: scale(1); }
            25% { transform: scale(1.1); }
            40% { transform: scale(1); }
            60% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .animate-beat {
            animation: heartbeat 1s infinite;
            display: inline-block;
        }

        /* New glow pulse animation for active calls */
        @keyframes glow-pulse {
            0% { box-shadow: 0 0 5px rgba(59, 130, 246, 0.4), 0 0 10px rgba(59, 130, 246, 0.3); }
            50% { box-shadow: 0 0 15px rgba(59, 130, 246, 0.6), 0 0 25px rgba(59, 130, 246, 0.4); }
            100% { box-shadow: 0 0 5px rgba(59, 130, 246, 0.4), 0 0 10px rgba(59, 130, 246, 0.3); }
        }
        .active-call-pulse {
            animation: glow-pulse 2s infinite;
            border: 2px solid #3b82f6;
        }

        .amount-input { width: 100px; }
        .scrollable-table { max-height: 400px; overflow-y: auto; }
        .fade-in-out { animation: fadeInOut 2.5s forwards; }
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(-10px);}
            10% { opacity: 1; transform: translateY(0);}
            90% { opacity: 1;}
            100% { opacity: 0; transform: translateY(-10px);}
        }

        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .animate-gradient {
            background-size: 200% auto;
            animation: gradient 4s linear infinite;
        }

        /* Pulse animation for icons */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .animate-pulse {
            animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        /* Dark Mode Toggle & Date Picker Styles */
        #dark-toggle {
            transform: scale(1);
            transition: all 0.3s ease;
        }

        #dark-toggle:hover {
            transform: scale(1.1);
        }

        #dark-toggle i {
            transform: rotate(0deg);
            transition: transform 0.3s ease;
        }

        #dark-toggle:active i {
            transform: rotate(360deg);
        }

        /* Date picker styles - consolidated */
        input[type="date"],
        input[type="time"],
        input[type="datetime-local"] {
            background-color: white !important;
            border: 1px solid #e2e8f0;
            color: #1a202c;
            border-radius: 0.375rem;
            padding: 0.375rem 0.75rem;
        }

        html.dark input[type="date"],
        html.dark input[type="time"],
        html.dark input[type="datetime-local"] {
            background-color: #1e293b !important;
            border-color: #475569;
            color: #f1f5f9;
        }

        input[type="date"]::-webkit-calendar-picker-indicator,
        input[type="time"]::-webkit-calendar-picker-indicator,
        input[type="datetime-local"]::-webkit-calendar-picker-indicator {
            background-color: transparent;
            cursor: pointer;
            padding: 0.25rem;
            filter: invert(0.8) brightness(1.2) saturate(0.8);
        }

        html.dark input[type="date"]::-webkit-calendar-picker-indicator,
        html.dark input[type="time"]::-webkit-calendar-picker-indicator,
        html.dark input[type="datetime-local"]::-webkit-calendar-picker-indicator {
            filter: invert(1) brightness(0.8) saturate(0.8);
        }

        /* Focus states */
        input[type="date"]:focus,
        input[type="time"]:focus,
        input[type="datetime-local"]:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
        }

        /* Enhanced Dark Mode Styles */
        html.dark {
            color-scheme: dark;
        }

        html.dark body {
            background-color: #0f172a;
            color: #f1f5f9;
        }

        html.dark .card,
        html.dark .modal,
        html.dark #call-modal,
        html.dark #settings-modal,
        html.dark #edit-cycle-modal {
            background-color: #1e293b;
            border: 1px solid #334155;
        }

        html.dark input,
        html.dark select,
        html.dark textarea {
            background-color: #334155;
            border-color: #475569;
            color: #f1f5f9;
        }

        /* Call log totals dark mode fix */
        html.dark #total-minutes,
        html.dark #total-earnings {
            color: #f1f5f9 !important;
        }

        html.dark .bg-gray-50 {
            background-color: #1f2937 !important;
        }

        html.dark tfoot tr {
            background-color: #1f2937 !important;
            color: #f1f5f9 !important;
        }

        /* Edit button visibility fixes */
        .edit-rate-btn,
        .edit-call-btn {
            display: inline-flex !important;
            align-items: center;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            background-color: #3b82f6;
            color: white !important;
            font-size: 0.75rem;
            font-weight: 600;
            gap: 0.25rem;
            transition: background-color 0.2s;
            margin: 0 0.25rem;
        }

        .edit-rate-btn:hover,
        .edit-call-btn:hover {
            background-color: #2563eb;
        }

        /* Improved text contrast in dark mode */
        html.dark .text-gray-900 {
            color: #f1f5f9 !important;
        }

        html.dark .text-gray-800 {
            color: #e2e8f0 !important;
        }

        html.dark .text-gray-700 {
            color: #cbd5e1 !important;
        }

        html.dark .bg-white {
            background-color: #1e293b !important;
        }

        html.dark .border-gray-200 {
            border-color: #334155 !important;
        }

        /* Rates card improvements */
        .rate-edit-form {
            background-color: white;
            padding: 0.5rem;
            border-radius: 0.75rem;
            margin-bottom: 1rem;
            width: 100%;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        html.dark .rate-edit-form {
            background-color: #1e293b;
            border: 1px solid #475569;
        }

        .rate-edit-form input {
            width: 100%;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            border-radius: 0.25rem;
            border: 1px solid #e2e8f0;
            transition: all 0.2s ease;
        }

        html.dark .rate-edit-form input {
            background-color: #334155;
            border-color: #475569;
            color: #f1f5f9;
        }

        .rate-edit-form button {
            transition: all 0.2s ease;
        }

        .rates-list-item {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            background-color: #f8fafc;
            border-radius: 0.375rem;
        }

        html.dark .rates-list-item {
            background-color: #1e293b;
        }

        .call-log-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        .call-log-table th,
        .call-log-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        html.dark .call-log-table th,
        html.dark .call-log-table td {
            border-bottom: 1px solid #334155;
        }

        .call-log-table th {
            font-weight: 600;
            background-color: #f8fafc;
        }

        html.dark .call-log-table th {
            background-color: #1e293b;
            color: #f1f5f9;
        }

        .call-log-table tr:hover {
            background-color: #f1f5f9;
        }

        html.dark .call-log-table tr:hover {
            background-color: #334155;
        }

        .tag {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            background-color: #e2e8f0;
            color: #4a5568;
            font-size: 0.875rem;
        }

        html.dark .tag {
            background-color: #475569;
            color: #f1f5f9;
        }

        /* Modal styles with dark mode */
        #call-modal,
        #settings-modal,
        #edit-cycle-modal {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            width: 90%;
        }

        html.dark #call-modal,
        html.dark #settings-modal,
        html.dark #edit-cycle-modal {
            background-color: #1e293b;
            border-color: #475569;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        #call-modal input,
        #call-modal select,
        #settings-modal input,
        #settings-modal select,
        #edit-cycle-modal input,
        #edit-cycle-modal select {
            width: 100%;
            padding: 8px;
            margin: 4px 0 12px;
            border-radius: 4px;
            border: 1px solid #e2e8f0;
        }

        html.dark #call-modal input,
        html.dark #call-modal select,
        html.dark #settings-modal input,
        html.dark #settings-modal select,
        html.dark #edit-cycle-modal input,
        html.dark #edit-cycle-modal select {
            background-color: #334155;
            border-color: #475569;
            color: #f1f5f9;
        }

        /* Button styles with dark mode */
        .btn-primary {
            background-color: #3b82f6;
            color: white;
            transition: background-color 0.2s;
        }

        .btn-primary:hover {
            background-color: #2563eb;
        }

        html.dark .btn-primary {
            background-color: #3b82f6;
        }

        html.dark .btn-primary:hover {
            background-color: #1d4ed8;
        }

        /* Call log table specific styles */
        .call-log-table td button {
            opacity: 1 !important;
            visibility: visible !important;
        }

        /* Make goal save button always visible */
        #goal-form button[type="submit"] {
            display: inline-flex !important;
            opacity: 1 !important;
            visibility: visible !important;
            background-color: #22c55e;
            color: white;
            padding: 0.375rem 0.75rem;
            border-radius: 0.375rem;
        }

        #goal-form button[type="submit"]:hover {
            background-color: #16a34a;
        }

        /* Style for Add Rate button */
        #show-rate-add {
            background-color: #dbeafe !important;
            color: #2563eb !important;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        #show-rate-add:hover {
            background-color: #bfdbfe !important;
        }

        html.dark #show-rate-add {
            background-color: #1e3a8a !important;
            color: #60a5fa !important;
        }

        html.dark #show-rate-add:hover {
            background-color: #1e40af !important;
        }

        /* Hidden file input */
        #file-input {
            display: none;
        }

        /* Responsive containers */
        .tracker-container {
            width: 100%;
            max-width: 320px;
        }

        @media (max-width: 640px) {
            .tracker-container {
                max-width: 100%;
            }

            .rate-edit-form button {
                width: 100%;
                margin-bottom: 0.5rem;
            }

            .rate-edit-form .flex {
                flex-direction: column;
            }
        }

        /* New Typography Styles */
        .font-poppins {
            font-family: 'Poppins', sans-serif;
        }

        h1 {
            font-weight: 700;
        }

        h2, h3, h4 {
            font-weight: 600;
        }

        /* Slogan Text Color Fix */
        .slogan-text-color {
            color: #4b5563; /* Default light mode color */
        }
        html.dark .slogan-text-color {
            color: #cbd5e1; /* Visible dark mode color */
        }
        
        /* Specific fix for text visibility within the payment cycle card */
        #payment-cycle-earnings-cards p {
            color: #4b5563; /* A medium gray for light mode */
        }
        
        html.dark #payment-cycle-earnings-cards p {
            color: #cbd5e1; /* A light gray for dark mode */
        }
        
        #payment-cycle-earnings-cards p .font-semibold {
            color: #1f2937; /* Very dark gray for contrast in light mode */
        }
        
        html.dark #payment-cycle-earnings-cards p .font-semibold {
            color: #f1f5f9; /* Very light gray for contrast in dark mode */
        }

        /* Fix for live call info alignment */
        #live-call-info {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        #live-call-info .flex {
            width: 100%;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors">
<div class="container mx-auto px-4 py-8 max-w-7xl">
    <div class="flex justify-end mb-4 gap-2">
        <button id="settings-toggle" aria-label="Open settings"
                class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 transition-all duration-300 focus:outline-none">
            <i class="fas fa-cog text-gray-600 dark:text-gray-300 transition-transform duration-300 text-xl"></i>
        </button>
        <button id="dark-toggle" aria-label="Toggle dark mode"
                class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 transition-all duration-300 focus:outline-none">
            <i class="fas fa-sun text-yellow-500 hidden dark:block text-xl"></i>
            <i class="fas fa-moon text-gray-600 dark:text-gray-300 block dark:hidden text-xl"></i>
        </button>
    </div>

    <header class="mb-12 text-center">
        <h1 class="text-4xl md:text-5xl font-poppins bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent mb-3 animate-gradient">
            Work Time Tracker
        </h1>
        <p class="text-lg md:text-xl text-gray-700 dark:text-gray-300 font-light tracking-wide mb-2">
            <span class="inline-block">
                <i class="fas fa-clock text-blue-500 dark:text-blue-400 mr-2 animate-pulse text-lg"></i>
                Track Your Time
            </span>
            <span class="mx-2">•</span>
            <span class="inline-block">
                <i class="fas fa-chart-line text-purple-500 dark:text-purple-400 mr-2 animate-pulse text-lg"></i>
                Monitor Earnings
            </span>
        </p>
        <p class="text-md md:text-lg font-poppins font-semibold bg-gradient-to-r from-blue-100 to-purple-100 dark:from-gray-900 dark:to-black py-1 px-3 rounded-full inline-block shadow-sm slogan-text-color">
            By Interpreters for Interpreters
        </p>
    </header>

<div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8" id="dashboard-grid">
    <div class="dark:bg-gray-800 rounded-xl shadow-lg p-6 w-full draggable-card" draggable="true" data-card-id="call-controls">
        <div class="flex flex-col items-center mb-4">
            <div class="bg-blue-100 dark:bg-blue-950 rounded-full w-16 h-16 flex items-center justify-center mb-3">
                <i class="fas fa-phone-volume text-3xl text-primary dark:text-blue-300"></i>
            </div>
            <h2 class="text-2xl font-poppins font-semibold mb-2 text-dark dark:text-gray-200">Call Controls</h2>
        </div>
        <div class="w-full mb-6">
            <label for="select-call-rate" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Select Rate</label>
            <select id="select-call-rate"
                class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200 bg-white dark:bg-gray-800">
            </select>
        </div>
        <div class="flex flex-col gap-4 w-full">
            <button id="add-call-btn" class="bg-blue-500 text-white px-4 py-3 rounded-lg hover:bg-blue-600 dark:bg-blue-500 dark:hover:bg-blue-600 transition w-full flex items-center justify-center gap-2 text-lg">
                <i class="fas fa-plus"></i> Add Call
            </button>
            <button id="start-call-btn" class="bg-green-500 text-white px-4 py-3 rounded-lg hover:bg-green-600 dark:hover:bg-green-800 transition w-full flex items-center justify-center gap-2 text-lg">
                <i class="fas fa-play"></i> Start Call
            </button>
            <button id="end-call-btn" class="bg-red-500 text-white px-4 py-3 rounded-lg hover:bg-red-600 dark:hover:bg-red-800 transition w-full flex items-center justify-center gap-2 text-lg" style="display:none;">
                <i class="fas fa-stop"></i> End Call
            </button>
        </div>
        <div id="live-call-info" class="mt-6 w-full rounded-lg shadow-inner transition-all" style="display:none;">
            <div class="flex flex-col items-center bg-green-50 dark:bg-green-900/40 rounded-lg p-4 w-full">
                <span class="text-green-700 dark:text-green-300 font-semibold text-lg mb-2">Ongoing Call</span>
                <span id="live-call-timer" class="font-mono text-3xl text-green-900 dark:text-green-200 font-bold mb-2">00:00:00</span>
                <span id="live-call-earnings" class="font-mono text-2xl text-green-800 dark:text-green-100 font-bold">$0.00 earned</span>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 gap-8" id="right-column">
        <div class="dark:bg-gray-800 rounded-xl shadow-lg p-6 w-full draggable-card" draggable="true" data-card-id="rates">
            <div class="flex flex-col items-center mb-4">
                <div class="bg-purple-100 dark:bg-purple-950 rounded-full w-16 h-16 flex items-center justify-center mb-3">
                    <i class="fas fa-dollar-sign text-3xl text-purple-500 dark:text-purple-300"></i>
                </div>
                <h2 class="text-2xl font-poppins font-semibold text-dark dark:text-gray-200">Rates</h2>
            </div>
            <div id="rates-list" class="mb-4">
            </div>
            <button id="show-rate-add" class="w-full flex items-center justify-center gap-2 py-1">
                <i class="fas fa-plus"></i> Add Rate
            </button>
            <form id="rate-form" class="rate-edit-form" style="display: none;">
                <input type="text" id="rate-name" placeholder="Rate Name" maxlength="50"
                    class="w-full mb-2 px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                <div class="flex items-center mb-2">
                    <span class="text-gray-600 dark:text-gray-300 mr-2 text-xl font-bold">$</span>
                    <input type="number" id="rate-amount" placeholder="Amount" step="0.01" min="0.01" max="999999"
                        class="flex-1 px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                    <span class="text-gray-600 dark:text-gray-300 ml-2">/min</span>
                </div>
                <div class="flex gap-2">
                    <button type="submit"
                        class="flex-1 bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 transition">
                        Save
                    </button>
                    <button type="button" id="cancel-rate-add"
                        class="flex-1 bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-200 px-4 py-2 rounded hover:bg-gray-400 dark:hover:bg-gray-700 transition">
                        Cancel
                    </button>
                </div>
            </form>
        </div>

        <div class="dark:bg-gray-800 rounded-xl shadow-lg p-6 w-full draggable-card" draggable="true" data-card-id="daily-goal">
            <div class="flex flex-col items-center mb-4">
                <div class="bg-green-100 dark:bg-green-950 rounded-full w-16 h-16 flex items-center justify-center mb-3">
                    <i class="fas fa-bullseye text-3xl text-green-500 dark:text-green-300"></i>
                </div>
                <h2 class="text-2xl font-poppins font-semibold text-dark dark:text-gray-200">Daily Goal</h2>
            </div>
            <form id="goal-form" class="flex items-center gap-2">
                <div class="flex-1">
                    <div class="flex items-center">
                        <span class="text-gray-600 dark:text-gray-300 mr-2 text-xl font-bold">$</span>
                        <input type="number" id="goal-amount" placeholder="Amount" step="0.01" min="0" max="999999"
                            class="flex-1 px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                </div>
                <button type="submit" class="px-4 py-2 rounded transition-colors duration-200">
                    <i class="fas fa-save"></i>
                </button>
            </form>
            <div class="mt-4">
                <div class="relative pt-1">
                    <div class="flex mb-2 items-center justify-between">
                        <div>
                            <span id="goal-progress-text"
                                class="text-xs font-semibold inline-block text-green-600 dark:text-green-400">
                                0%
                            </span>
                        </div>
                        <div class="text-right">
                            <span id="goal-amount-display"
                                class="text-xs font-semibold inline-block text-green-600 dark:text-green-400">
                                $0 / $0
                            </span>
                        </div>
                    </div>
                    <div class="flex h-2 mb-4 overflow-hidden bg-green-200 rounded dark:bg-green-900">
                        <div id="goal-progress-bar"
                            class="flex flex-col justify-center overflow-hidden bg-green-500"
                            role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden mb-8 p-6">
    <h2 class="text-2xl font-poppins font-semibold text-gray-900 dark:text-gray-100 mb-4">
        <i class="fas fa-chart-bar text-purple-500 mr-2"></i>Call Statistics
    </h2>
    <div class="flex justify-between items-center mb-6">
        <div class="flex items-center gap-4 flex-wrap">
            <input type="date" id="stats-date-picker"
                   class="px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200"
            />
            <button id="current-date-btn"
                    class="px-4 py-2 bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300 rounded-lg hover:bg-blue-200 dark:hover:bg-blue-800 transition-colors">
                Current Date
            </button>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-4">
        <div class="bg-blue-50 dark:bg-blue-900/40 p-4 rounded-lg">
            <h3 class="text-blue-700 dark:text-blue-300 font-medium mb-2 text-xl">
                <i class="fas fa-clock mr-2"></i>Average Call Duration
            </h3>
            <p id="avg-duration" class="text-2xl font-bold text-blue-800 dark:text-blue-200">00:00:00</p>
        </div>
        <div class="bg-green-50 dark:bg-green-900/40 p-4 rounded-lg draggable-card" draggable="true" data-card-id="goal-progress">
            <h3 class="text-green-700 dark:text-green-300 font-medium mb-2 text-xl">
                <i class="fas fa-bullseye mr-2"></i>Goal Progress
            </h3>
            <p id="goal-estimate" class="text-2xl font-bold text-green-800 dark:text-green-200">-- mins to goal</p>
        </div>
        <div class="bg-yellow-50 dark:bg-yellow-900/40 p-4 rounded-lg draggable-card" draggable="true" data-card-id="today-earnings">
            <h3 class="text-yellow-700 dark:text-yellow-300 font-medium mb-2 text-xl">
                <i class="fas fa-chart-line mr-2"></i>Today's Earnings
            </h3>
            <p id="today-earnings" class="text-2xl font-bold text-yellow-800 dark:text-yellow-200">$0.00</p>
        </div>
    </div>

    <div id="monthly-earnings-cards" class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-purple-50 dark:bg-purple-900/40 p-4 rounded-lg draggable-card" draggable="true" data-card-id="second-half-earnings">
            <h3 class="text-purple-700 dark:text-purple-300 font-medium mb-2 text-xl">
                <i class="fas fa-calendar-alt mr-2"></i>First Half of Month
            </h3>
            <p class="text-lg text-purple-800 dark:text-purple-200 font-bold">
                <span id="first-half-earnings">$0.00</span>
            </p>
        </div>
        <div class="bg-purple-50 dark:bg-purple-900/40 p-4 rounded-lg draggable-card" draggable="true" data-card-id="monthly-total-earnings">
            <h3 class="text-purple-700 dark:text-purple-300 font-medium mb-2 text-xl">
                <i class="fas fa-calendar-alt mr-2"></i>Second Half of Month
            </h3>
            <p class="text-lg text-purple-800 dark:text-purple-200 font-bold">
                <span id="second-half-earnings">$0.00</span>
            </p>
        </div>
        <div class="bg-purple-50 dark:bg-purple-900/40 p-4 rounded-lg">
            <h3 class="text-purple-700 dark:text-purple-300 font-medium mb-2 text-xl">
                <i class="fas fa-dollar-sign mr-2"></i>Total in Current Month
            </h3>
            <p class="text-lg text-purple-800 dark:text-purple-200 font-bold">
                <span id="monthly-total-earnings">$0.00</span>
            </p>
        </div>
    </div>

    <div id="payment-cycle-earnings-cards" class="grid grid-cols-1 md:grid-cols-3 gap-6 hidden">
        <div class="bg-purple-50 dark:bg-purple-900/40 p-4 rounded-lg">
            <h3 class="text-purple-700 dark:text-purple-300 font-medium mb-2 text-xl">
                <i class="fas fa-money-bill-wave mr-2"></i>Current Cycle Earnings
            </h3>
            <p id="cycle-earnings" class="text-2xl font-bold text-purple-800 dark:text-purple-200">
                $0.00
            </p>
        </div>
        <div class="bg-purple-50 dark:bg-purple-900/40 p-4 rounded-lg">
            <h3 class="text-purple-700 dark:text-purple-300 font-medium mb-2 text-xl">
                <i class="fas fa-calendar-check mr-2"></i>Cycle Progress
            </h3>
            <div class="text-sm text-gray-900 dark:text-gray-100">
                <p class="mb-1">
                    <i class="fas fa-calendar-day mr-2"></i>
                    Start: <span id="cycle-start-date" class="font-semibold">N/A</span>
                </p>
                <p class="mb-1">
                    <i class="fas fa-calendar-day mr-2"></i>
                    End: <span id="cycle-end-date" class="font-semibold">N/A</span>
                </p>
                <p>
                    <i class="fas fa-calendar-check mr-2"></i>
                    Days Left: <span id="days-until-end" class="font-semibold">N/A</span>
                </p>
            </div>
        </div>
        <div class="bg-purple-50 dark:bg-purple-900/40 p-4 rounded-lg">
            <h3 class="text-purple-700 dark:text-purple-300 font-medium mb-2 text-xl">
                <i class="fas fa-clock mr-2"></i>Pay Day Countdown
            </h3>
            <div class="text-sm text-gray-900 dark:text-gray-100">
                <p class="mb-1">
                    <i class="fas fa-calendar-dollar mr-2"></i>
                    Pay Date: <span id="pay-date" class="font-semibold">N/A</span>
                </p>
                <p>
                    <i class="fas fa-clock mr-2"></i>
                    Days to Pay: <span id="days-until-pay" class="font-semibold">N/A</span>
                </p>
            </div>
        </div>
    </div>
</div>

<div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden mb-8 p-6">
    <div class="flex flex-col md:flex-row items-center justify-between gap-4 mb-6">
        <h2 class="text-2xl font-poppins font-semibold text-gray-900 dark:text-gray-100">
            <i class="fas fa-history text-blue-500 mr-2"></i>Call Log
        </h2>
        <div class="flex flex-wrap items-center gap-4">
            <button id="filter-today" class="px-3 py-1 text-sm rounded-full bg-blue-500 text-white dark:bg-blue-600 dark:text-white">Today</button>
            <button id="filter-week" class="px-3 py-1 text-sm rounded-full bg-gray-200 text-gray-700 dark:bg-gray-700 dark:text-gray-200">Past Week</button>
            <button id="filter-month" class="px-3 py-1 text-sm rounded-full bg-gray-200 text-gray-700 dark:bg-gray-700 dark:text-gray-200">Past Month</button>
        </div>
        <div class="flex flex-wrap items-center gap-4">
            <div class="flex items-center gap-2">
                <span class="text-gray-600 dark:text-gray-400">Total Time:</span>
                <span id="total-minutes" class="font-mono text-lg">00:00:00</span>
            </div>
            <div class="flex items-center gap-2">
                <span class="text-gray-600 dark:text-gray-400">Total Earnings:</span>
                <span id="total-earnings" class="font-mono text-lg">$0.00</span>
            </div>
        </div>
    </div>
    <div class="overflow-x-auto">
        <table class="call-log-table w-full">
            <thead>
            <tr class="text-left">
                <th class="font-semibold">Date</th>
                <th class="font-semibold">Duration</th>
                <th class="font-semibold">Rate</th>
                <th class="font-semibold pl-4">Actions</th>
            </tr>
            </thead>
            <tbody id="call-log">
            </tbody>
            <tfoot>
            <tr class="bg-gray-50 dark:bg-gray-800">
                <td colspan="5" class="py-4 text-center text-gray-500 dark:text-gray-400">
                    End of call log
                </td>
            </tr>
            </tfoot>
        </table>
    </div>
</div>

<div id="call-modal" style="display: none;"
     role="dialog" aria-labelledby="modal-title" aria-modal="true" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100" id="modal-title">Add Call</h3>
            <button id="close-modal" aria-label="Close modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="call-form">
            <div class="mb-4">
                <label for="call-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Date & Time</label>
                <input type="datetime-local" id="call-date" required class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200">
            </div>
            <div class="mb-4">
                <label for="call-duration-hours" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Duration (HH:MM:SS)</label>
                <div class="flex gap-2">
                    <input type="number" id="call-duration-hours" min="0" max="24" placeholder="HH" aria-label="Hours" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200">
                    <input type="number" id="call-duration-minutes" min="0" max="59" placeholder="MM" aria-label="Minutes" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200">
                    <input type="number" id="call-duration-seconds" min="0" max="59" placeholder="SS" aria-label="Seconds" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200">
                </div>
            </div>
            <div class="mb-6">
                <label for="call-rate" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Rate</label>
                <select id="call-rate" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200">
                </select>
            </div>
            <div class="flex justify-end gap-3">
                <button type="button" id="cancel-call" class="px-4 py-2 text-gray-700 bg-gray-200 rounded hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600"> Cancel </button>
                <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"> Save </button>
            </div>
        </form>
    </div>
</div>
<div id="settings-modal" style="display: none;"
     role="dialog" aria-labelledby="settings-modal-title" aria-modal="true" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100" id="settings-modal-title">Settings</h3>
            <button id="close-settings-modal" aria-label="Close settings" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="space-y-4">
            <div class="border-b border-gray-200 dark:border-gray-700 pb-4">
                <h4 class="text-lg font-medium text-gray-900 dark:text-gray-100 mb-3">Data Management</h4>
                <div class="flex flex-col gap-2">
                    <button id="export-data" class="flex items-center gap-2 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors">
                        <i class="fas fa-download"></i> Export Data
                    </button>
                    <label for="import-file" class="flex items-center gap-2 px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 transition-colors cursor-pointer">
                        <i class="fas fa-upload"></i> Import Data
                    </label>
                    <input type="file" id="import-file" accept=".json" class="hidden">
                </div>
            </div>
            <div class="border-b border-gray-200 dark:border-gray-700 pb-4">
    <h4 class="text-lg font-medium text-gray-900 dark:text-gray-100 mb-3">Time Zone Settings</h4>
    <div class="mb-4">
        <label for="timezone-select" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Select Your Time Zone</label>
        <select id="timezone-select" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200">
        </select>
    </div>
</div>
            <div class="border-b border-gray-200 dark:border-gray-700 pb-4">
                <h4 class="text-lg font-medium text-gray-900 dark:text-gray-100 mb-3">Storage</h4>
                <div class="mb-2">
                    <div class="flex justify-between text-sm text-gray-600 dark:text-gray-400 mb-1">
                        <span>Storage Used</span>
                        <span id="storage-used">Calculating...</span>
                    </div>
                    <div class="h-2 bg-gray-200 dark:bg-gray-700 rounded">
                        <div id="storage-bar" class="h-2 bg-blue-500 rounded" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            <div class="border-b border-gray-200 dark:border-gray-700 pb-4">
                <div class="flex justify-between items-center mb-3">
                    <h4 class="text-lg font-medium text-gray-900 dark:text-gray-100">Payment Cycles</h4>
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="payment-cycles-toggle" class="sr-only peer">
                        <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                        <span class="ml-3 text-sm font-medium text-gray-900 dark:text-gray-300">Enable Payment Cycles</span>
                    </label>
                </div>
                <div id="payment-cycles-config" class="hidden">
                    <div class="mb-3">
                        <button id="show-add-cycle-btn" class="flex items-center gap-2 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors">
                            <i class="fas fa-plus"></i> Add Payment Cycle
                        </button>
                    </div>
                    <div class="max-h-48 overflow-y-auto">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                            <thead class="bg-gray-50 dark:bg-gray-800">
                            <tr>
                                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Start Date</th>
                                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">End Date</th>
                                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Pay Date</th>
                                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Actions</th>
                            </tr>
                            </thead>
                            <tbody id="payment-cycles-list" class="bg-white divide-y divide-gray-200 dark:bg-gray-900 dark:divide-gray-700">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div>
                <h4 class="text-lg font-medium text-gray-900 dark:text-gray-100 mb-3">Reset & Erase</h4>
                <div class="flex flex-col gap-2">
                    <button id="reset-calls" class="flex items-center gap-2 px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition-colors">
                        <i class="fas fa-trash-alt"></i> Erase All Calls
                    </button>
                    <button id="reset-all" class="flex items-center gap-2 px-4 py-2 bg-red-700 text-white rounded hover:bg-red-800 transition-colors">
                        <i class="fas fa-exclamation-triangle"></i> Reset All Data
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="edit-cycle-modal" style="display: none;"
     role="dialog" aria-labelledby="edit-cycle-modal-title" aria-modal="true" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100" id="edit-cycle-modal-title">Edit Payment Cycle</h3>
            <button id="close-edit-cycle-modal" aria-label="Close modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="edit-cycle-form">
            <div class="mb-4">
                <label for="cycle-start-date-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Start Date</label>
                <input type="date" id="cycle-start-date-input" required class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200">
            </div>
            <div class="mb-4">
                <label for="cycle-end-date-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">End Date</label>
                <input type="date" id="cycle-end-date-input" required class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200">
            </div>
            <div class="mb-6">
                <label for="cycle-pay-date-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Pay Date</label>
                <input type="date" id="cycle-pay-date-input" required class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200">
            </div>
            <div class="flex justify-end gap-3">
                <button type="button" id="cancel-edit-cycle" class="px-4 py-2 text-gray-700 bg-gray-200 rounded hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600"> Cancel </button>
                <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"> Save </button>
            </div>
        </form>
    </div>
</div>


<footer class="border-t border-gray-200 dark:border-gray-700 mt-8">
    <div class="container mx-auto px-4 py-8 text-center">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 justify-items-center">
            <div class="text-center">
                <h3 class="text-gray-700 dark:text-gray-300 font-semibold mb-3">Work Time Tracker</h3>
                <p class="text-gray-600 dark:text-gray-300 flex items-center justify-center gap-2">
                    Made with
                    <span class="inline-block">
                        <i class="fas fa-heart text-red-500 animate-beat"></i>
                    </span>
                    by
                    <a href="https://www.instagram.com/otpo/"
                        target="_blank"
                        rel="noopener noreferrer"
                        class="text-blue-500 hover:text-blue-600 dark:text-blue-400 dark:hover:text-blue-300 transition-colors">
                        Topo
                    </a>
                </p>
            </div>
            <div class="text-center">
                <h3 class="text-gray-700 dark:text-gray-300 font-semibold mb-3">Your Local Time</h3>
                <p id="local-time" class="text-lg font-semibold text-gray-700 dark:text-gray-300"></p>
                <p class="text-sm text-gray-600 dark:text-gray-400" id="user-time-zone"></p>
            </div>
        </div>
        <div class="border-t border-gray-200 dark:border-gray-700 mt-8 pt-4 text-center text-sm text-gray-600 dark:text-gray-400">
            <p>© 2025 Work Time Tracker. All rights reserved.</p>
            <p class="mt-2">
                <button id="privacy-policy" class="hover:text-blue-500 dark:hover:text-blue-400 transition-colors">Privacy Policy</button>
                <span class="mx-2">•</span>
                <button id="terms-of-service" class="hover:text-blue-500 dark:hover:text-blue-400 transition-colors">Terms of Service</button>
            </p>
        </div>
    </div>
</footer>

<script>
    // Drag and Drop Functions
    function setupDragAndDrop() {
        const cards = document.querySelectorAll('.draggable-card');
        let draggedCard = null;
        let placeholder = null;

        cards.forEach(card => {
            card.addEventListener('dragstart', (e) => {
                draggedCard = card;
                card.classList.add('dragging');
                e.dataTransfer.setData('text/plain', card.dataset.cardId);
                e.dataTransfer.effectAllowed = 'move';
                
                // Create a placeholder
                placeholder = document.createElement('div');
                placeholder.className = 'draggable-card placeholder';
                placeholder.style.height = `${card.offsetHeight}px`;
                placeholder.style.width = `${card.offsetWidth}px`;
            });

            card.addEventListener('dragend', () => {
                card.classList.remove('dragging');
                if (placeholder && placeholder.parentNode) {
                    placeholder.parentNode.removeChild(placeholder);
                }
                draggedCard = null;
                placeholder = null;
                saveCardPositions();
            });

            card.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                
                if (!draggedCard || card === draggedCard) return;
                
                const rect = card.getBoundingClientRect();
                const midY = rect.top + rect.height / 2;
                
                if (e.clientY < midY) {
                    card.parentNode.insertBefore(placeholder, card);
                } else {
                    card.parentNode.insertBefore(placeholder, card.nextSibling);
                }
            });

            card.addEventListener('drop', (e) => {
                e.preventDefault();
                if (!draggedCard || card === draggedCard) return;
                
                const rect = card.getBoundingClientRect();
                const midY = rect.top + rect.height / 2;
                
                if (e.clientY < midY) {
                    card.parentNode.insertBefore(draggedCard, card);
                } else {
                    card.parentNode.insertBefore(draggedCard, card.nextSibling);
                }
            });
        });

        // Make grid containers droppable
        const grids = document.querySelectorAll('#dashboard-grid, #right-column, #stats-cards, #monthly-earnings-cards');
        grids.forEach(grid => {
            grid.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                
                if (!draggedCard) return;
                
                // If grid is empty or we're at the end, append
                if (grid.children.length === 0 || 
                    e.clientY > grid.lastElementChild.getBoundingClientRect().bottom) {
                    grid.appendChild(placeholder);
                }
            });

            grid.addEventListener('drop', (e) => {
                e.preventDefault();
                if (!draggedCard) return;
                
                // If grid is empty or we're at the end, append
                if (grid.children.length === 0 || 
                    e.clientY > grid.lastElementChild.getBoundingClientRect().bottom) {
                    grid.appendChild(draggedCard);
                }
            });
        });
    }

    function saveCardPositions() {
        const positions = {
            dashboard: Array.from(document.querySelectorAll('#dashboard-grid > .draggable-card')).map(card => card.dataset.cardId),
            rightColumn: Array.from(document.querySelectorAll('#right-column > .draggable-card')).map(card => card.dataset.cardId),
            stats: Array.from(document.querySelectorAll('#stats-cards > .draggable-card')).map(card => card.dataset.cardId),
            monthly: Array.from(document.querySelectorAll('#monthly-earnings-cards > .draggable-card')).map(card => card.dataset.cardId)
        };
        localStorage.setItem('cardPositions', JSON.stringify(positions));
    }

    function loadCardPositions() {
        const savedPositions = localStorage.getItem('cardPositions');
        if (!savedPositions) return;

        try {
            const positions = JSON.parse(savedPositions);
            const allCards = document.querySelectorAll('.draggable-card');
            const cardMap = {};
            
            allCards.forEach(card => {
                cardMap[card.dataset.cardId] = card;
                card.remove();
            });

            // Reinsert cards in saved order
            positions.dashboard.forEach(id => {
                if (cardMap[id]) {
                    document.getElementById('dashboard-grid').appendChild(cardMap[id]);
                }
            });

            positions.rightColumn.forEach(id => {
                if (cardMap[id]) {
                    document.getElementById('right-column').appendChild(cardMap[id]);
                }
            });

            positions.stats.forEach(id => {
                if (cardMap[id]) {
                    document.getElementById('stats-cards').appendChild(cardMap[id]);
                }
            });

            positions.monthly.forEach(id => {
                if (cardMap[id]) {
                    document.getElementById('monthly-earnings-cards').appendChild(cardMap[id]);
                }
            });

        } catch (e) {
            console.error('Failed to load card positions:', e);
        }
    }

    // Global variables
    const startCallBtn = document.getElementById('start-call-btn');
    const endCallBtn = document.getElementById('end-call-btn');
    const liveCallInfo = document.getElementById('live-call-info');
    const liveCallTimerDisplay = document.getElementById('live-call-timer');
    const liveCallEarningsDisplay = document.getElementById('live-call-earnings');
    const callLogTableBody = document.getElementById('call-log');
    const totalMinutesDisplay = document.getElementById('total-minutes');
    const totalEarningsDisplay = document.getElementById('total-earnings');
    const rateSelect = document.getElementById('select-call-rate');
    const ratesList = document.getElementById('rates-list');
    const addCallBtn = document.getElementById('add-call-btn');
    const callModal = document.getElementById('call-modal');
    const closeModalBtn = document.getElementById('close-modal');
    const callForm = document.getElementById('call-form');
    const cancelCallBtn = document.getElementById('cancel-call');
    const callDateInput = document.getElementById('call-date');
    const callDurationHoursInput = document.getElementById('call-duration-hours');
    const callDurationMinutesInput = document.getElementById('call-duration-minutes');
    const callDurationSecondsInput = document.getElementById('call-duration-seconds');
    const callRateSelect = document.getElementById('call-rate');
    const darkToggleBtn = document.getElementById('dark-toggle');
    const showRateAddBtn = document.getElementById('show-rate-add');
    const rateForm = document.getElementById('rate-form');
    const cancelRateAddBtn = document.getElementById('cancel-rate-add');
    const settingsToggleBtn = document.getElementById('settings-toggle');
    const settingsModal = document.getElementById('settings-modal');
    const closeSettingsModalBtn = document.getElementById('close-settings-modal');
    const exportDataBtn = document.getElementById('export-data');
    const importFile = document.getElementById('import-file');
    const resetCallsBtn = document.getElementById('reset-calls');
    const resetAllBtn = document.getElementById('reset-all');
    const statsDatePicker = document.getElementById('stats-date-picker');
    const currentDateBtn = document.getElementById('current-date-btn');
    const avgDurationDisplay = document.getElementById('avg-duration');
    const todayEarningsDisplay = document.getElementById('today-earnings');
    const goalEstimateDisplay = document.getElementById('goal-estimate');
    const firstHalfEarningsDisplay = document.getElementById('first-half-earnings');
    const secondHalfEarningsDisplay = document = document.getElementById('second-half-earnings');
    const monthlyTotalEarningsDisplay = document.getElementById('monthly-total-earnings');
    const goalForm = document.getElementById('goal-form');
    const goalAmountInput = document.getElementById('goal-amount');
    const goalProgressText = document.getElementById('goal-progress-text');
    const goalAmountDisplay = document.getElementById('goal-amount-display');
    const goalProgressBar = document.getElementById('goal-progress-bar');
    const paymentCyclesToggle = document.getElementById('payment-cycles-toggle');
    const paymentCyclesConfig = document.getElementById('payment-cycles-config');
    const paymentCyclesList = document.getElementById('payment-cycles-list');
    const showAddCycleBtn = document.getElementById('show-add-cycle-btn');
    const cycleEarningsDisplay = document.getElementById('cycle-earnings');
    const cycleStartDateDisplay = document.getElementById('cycle-start-date');
    const cycleEndDateDisplay = document.getElementById('cycle-end-date');
    const daysUntilEndDisplay = document.getElementById('days-until-end');
    const payDateDisplay = document.getElementById('pay-date');
    const daysUntilPayDisplay = document.getElementById('days-until-pay');
    const monthlyEarningsCards = document.getElementById('monthly-earnings-cards');
    const paymentCycleEarningsCards = document.getElementById('payment-cycle-earnings-cards');
    const storageUsedDisplay = document.getElementById('storage-used');
    const storageBar = document.getElementById('storage-bar');
    const localTimeDisplay = document.getElementById('local-time');
    const userTimeZoneDisplay = document.getElementById('user-time-zone');
    const editCycleModal = document.getElementById('edit-cycle-modal');
    const closeEditCycleModalBtn = document.getElementById('close-edit-cycle-modal');
    const cancelEditCycleBtn = document.getElementById('cancel-edit-cycle');
    const editCycleForm = document.getElementById('edit-cycle-form');
    const cycleStartDateInput = document.getElementById('cycle-start-date-input');
    const cycleEndDateInput = document.getElementById('cycle-end-date-input');
    const cyclePayDateInput = document.getElementById('cycle-pay-date-input');
    
    const filterTodayBtn = document.getElementById('filter-today');
    const filterWeekBtn = document.getElementById('filter-week');
    const filterMonthBtn = document.getElementById('filter-month');

    const timezoneSelect = document.getElementById('timezone-select');
    let userTimezone = localStorage.getItem('userTimezone') || Intl.DateTimeFormat().resolvedOptions().timeZone;
    
    // Bug Fix: Add try-catch for local storage parsing to prevent app crash on corrupted data
    let rates, calls, dailyGoal, paymentCyclesEnabled, paymentCycles, lastSelectedRate;
    try {
        rates = JSON.parse(localStorage.getItem('rates')) || [];
        calls = JSON.parse(localStorage.getItem('calls')) || [];
        dailyGoal = JSON.parse(localStorage.getItem('dailyGoal')) || { amount: 0 };
        paymentCyclesEnabled = JSON.parse(localStorage.getItem('paymentCyclesEnabled')) || false;
        paymentCycles = JSON.parse(localStorage.getItem('paymentCycles')) || [];
        lastSelectedRate = localStorage.getItem('lastSelectedRate') || null;
    } catch (e) {
        console.error("Failed to parse local storage data. Resetting app data.", e);
        localStorage.clear();
        rates = [];
        calls = [];
        dailyGoal = { amount: 0 };
        paymentCyclesEnabled = false;
        paymentCycles = [];
        lastSelectedRate = null;
    }

    let activeTimers = new Set();
    let liveCallTimerId = null;
    let liveCallStart = null;
    let currentCallRate = null;
    let isEditingCall = false;
    let editingCallIndex = null;
    let isEditingCycle = false;
    let editingCycleIndex = null;
    let callLogFilter = 'today'; // New state for filtering

    // Helper Functions
    function formatTime(milliseconds) {
        const totalSeconds = Math.floor(milliseconds / 1000);
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;
        return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    }

    function formatDate(date) {
        if (!date) return 'N/A';
        // Fix for time zone issue - use UTC methods
        const d = new Date(date);
        const year = d.getUTCFullYear();
        const month = String(d.getUTCMonth() + 1).padStart(2, '0');
        const day = String(d.getUTCDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    function formatDateTime(date) {
    // First create a date object from the input
    const d = new Date(date);
    
    // Convert the date to the user's selected timezone
    // This ensures all dates shown in the app respect the selected timezone
    return new Date(d.toLocaleString('en-US', { timeZone: userTimezone })).toLocaleString([], {
        year: 'numeric',     // Show full year (e.g., 2025)
        month: 'numeric',    // Show month as number
        day: 'numeric',      // Show day of month
        hour: '2-digit',     // Show hours in 2-digit format
        minute: '2-digit'    // Show minutes in 2-digit format
    });
}

    function formatEarnings(amount) {
        return `$${amount.toFixed(2)}`;
    }
    
    function updateLocalTime() {
    // Create a new date object for current time
    const now = new Date();
    
    // Convert current time to user's selected timezone
    const timeZoneDate = new Date(now.toLocaleString('en-US', { timeZone: userTimezone }));
    
    // Format the date part with full details
    const dateString = timeZoneDate.toLocaleDateString(undefined, { 
        weekday: 'long',     // e.g., "Monday"
        year: 'numeric',     // e.g., "2025"
        month: 'long',       // e.g., "October"
        day: 'numeric'       // e.g., "10"
    });
    
    // Format the time part
    const timeString = timeZoneDate.toLocaleTimeString(undefined, { 
        hour: '2-digit',     // e.g., "07"
        minute: '2-digit',   // e.g., "31"
        second: '2-digit'    // e.g., "20"
    });
    
    // Update the display in the footer
    localTimeDisplay.textContent = `${dateString}, ${timeString}`;
    // Show the current timezone name (replace underscores with spaces for readability)
    userTimeZoneDisplay.textContent = userTimezone.replace(/_/g, ' ');
}

    function updateStorageInfo() {
        const totalBytes = new Blob([JSON.stringify(localStorage)]).size;
        const totalKB = totalBytes / 1024;
        const maxStorageKB = 5000;
        const usagePercentage = (totalKB / maxStorageKB) * 100;
        storageUsedDisplay.textContent = `${totalKB.toFixed(2)} KB`;
        storageBar.style.width = `${Math.min(usagePercentage, 100)}%`;
        storageBar.style.backgroundColor = usagePercentage > 80 ? '#ef4444' : '#3b82f6';
    }

    function updateStatistics() {
        const selectedDate = statsDatePicker.value || new Date().toISOString().split('T')[0];
        const todayCalls = calls.filter(call => new Date(call.startTime).toISOString().split('T')[0] === selectedDate);
        const todayTotalDuration = todayCalls.reduce((sum, call) => sum + call.duration, 0);
        const todayTotalEarnings = todayCalls.reduce((sum, call) => sum + call.earned, 0);
        const averageDuration = todayCalls.length > 0 ? todayTotalDuration / todayCalls.length : 0;
        avgDurationDisplay.textContent = formatTime(averageDuration);
        todayEarningsDisplay.textContent = formatEarnings(todayTotalEarnings);

        const progress = dailyGoal.amount > 0 ? (todayTotalEarnings / dailyGoal.amount) * 100 : 0;
        goalProgressText.textContent = `${Math.min(progress.toFixed(0), 100)}%`;
        goalAmountDisplay.textContent = `${formatEarnings(todayTotalEarnings)} / ${formatEarnings(dailyGoal.amount)}`;
        goalProgressBar.style.width = `${Math.min(progress, 100)}%`;
        goalProgressBar.style.backgroundColor = progress >= 100 ? '#22c55e' : '#3b82f6';

        if (todayTotalEarnings < dailyGoal.amount && todayCalls.length > 0) {
            const currentAvgRate = todayCalls.reduce((sum, call) => sum + call.rate, 0) / todayCalls.length;
            if (currentAvgRate > 0) {
                const remainingToGoal = dailyGoal.amount - todayTotalEarnings;
                const estimatedMinutes = remainingToGoal / currentAvgRate;
                goalEstimateDisplay.textContent = `${estimatedMinutes.toFixed(1)} mins to goal`;
            } else {
                goalEstimateDisplay.textContent = 'N/A';
            }
        } else {
            goalEstimateDisplay.textContent = todayTotalEarnings >= dailyGoal.amount ? 'Goal met!' : '-- mins to goal';
        }

        const now = new Date();
        const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
        const midOfMonth = new Date(now.getFullYear(), now.getMonth(), 16);
        const firstHalfEarnings = calls.filter(call => {
            const callDate = new Date(call.startTime);
            return callDate >= startOfMonth && callDate < midOfMonth;
        }).reduce((sum, call) => sum + call.earned, 0);

        const secondHalfEarnings = calls.filter(call => {
            const callDate = new Date(call.startTime);
            return callDate >= midOfMonth && callDate <= now;
        }).reduce((sum, call) => sum + call.earned, 0);

        firstHalfEarningsDisplay.textContent = formatEarnings(firstHalfEarnings);
        secondHalfEarningsDisplay.textContent = formatEarnings(secondHalfEarnings);
        monthlyTotalEarningsDisplay.textContent = formatEarnings(firstHalfEarnings + secondHalfEarnings);

        const currentCycle = paymentCycles.find(cycle => {
            const now = new Date();
            const start = new Date(cycle.startDate);
            const end = new Date(cycle.endDate);
            return now >= start && now <= end;
        });

        if (currentCycle) {
            const cycleCalls = calls.filter(call => {
                const callDate = new Date(call.startTime);
                return callDate >= new Date(currentCycle.startDate) && callDate <= new Date(currentCycle.endDate);
            });
            const cycleEarnings = cycleCalls.reduce((sum, call) => sum + call.earned, 0);
            cycleEarningsDisplay.textContent = formatEarnings(cycleEarnings);
            // Fix for date display
            const cycleStartLocal = new Date(currentCycle.startDate);
            const cycleEndLocal = new Date(currentCycle.endDate);
            const cyclePayLocal = new Date(currentCycle.payDate);

            cycleStartDateDisplay.textContent = cycleStartLocal.toLocaleDateString();
            cycleEndDateDisplay.textContent = cycleEndLocal.toLocaleDateString();
            payDateDisplay.textContent = cyclePayLocal.toLocaleDateString();
            
            const daysLeft = Math.ceil((new Date(currentCycle.endDate) - now) / (1000 * 60 * 60 * 24));
            daysUntilEndDisplay.textContent = daysLeft > 0 ? `${daysLeft} day${daysLeft > 1 ? 's' : ''}` : 'Today!';
            const daysToPay = Math.ceil((new Date(currentCycle.payDate) - now) / (1000 * 60 * 60 * 24));
            daysUntilPayDisplay.textContent = daysToPay > 0 ? `${daysToPay} day${daysToPay > 1 ? 's' : ''}` : 'Today!';
        } else {
            cycleEarningsDisplay.textContent = '$0.00';
            cycleStartDateDisplay.textContent = 'N/A';
            cycleEndDateDisplay.textContent = 'N/A';
            payDateDisplay.textContent = 'N/A';
            daysUntilEndDisplay.textContent = 'N/A';
            daysUntilPayDisplay.textContent = 'N/A';
        }
    }

    function saveRates() {
        localStorage.setItem('rates', JSON.stringify(rates));
        displayRates();
        populateRateSelects();
        updateStorageInfo();
    }

    function saveCalls() {
        localStorage.setItem('calls', JSON.stringify(calls));
        // displayCalls();
        updateStatistics();
        updateStorageInfo();
        // Re-render the call log based on the current filter
        if (callLogFilter === 'date') {
            displayCallsByDate(statsDatePicker.value);
        } else {
            displayCalls();
        }
    }

    function saveDailyGoal() {
        localStorage.setItem('dailyGoal', JSON.stringify(dailyGoal));
        updateStatistics();
        updateStorageInfo();
    }

    function savePaymentCycles() {
        localStorage.setItem('paymentCyclesEnabled', JSON.stringify(paymentCyclesEnabled));
        localStorage.setItem('paymentCycles', JSON.stringify(paymentCycles));
        renderPaymentCycles();
        updateStatistics();
        updateStorageInfo();
    }
    
    function saveLastSelectedRate() {
        const selectedRate = rateSelect.value;
        if (selectedRate) {
            localStorage.setItem('lastSelectedRate', selectedRate);
        }
    }

    // Rate Management
    function displayRates() {
        ratesList.innerHTML = '';
        if (rates.length === 0) {
            ratesList.innerHTML = `<p class="text-sm text-gray-500 dark:text-gray-400 text-center">No rates added yet.</p>`;
            return;
        }
        rates.forEach((rate, index) => {
            const div = document.createElement('div');
            div.className = 'rates-list-item bg-gray-50 dark:bg-gray-700 p-3 rounded-lg flex items-center justify-between mb-2';
            div.innerHTML = `
                <div class="flex-1">
                    <span class="font-medium text-gray-900 dark:text-gray-100">${rate.name}</span>
                    <span class="text-gray-600 dark:text-gray-400 text-sm ml-2">$${rate.amount.toFixed(2)}/min</span>
                </div>
                <div>
                    <button class="edit-rate-btn text-blue-500 hover:text-blue-700 mr-2" data-index="${index}">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="delete-rate-btn text-red-500 hover:text-red-700" data-index="${index}">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            ratesList.appendChild(div);
        });

        document.querySelectorAll('.edit-rate-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const index = e.currentTarget.dataset.index;
                const rateToEdit = rates[index];
                document.getElementById('rate-name').value = rateToEdit.name;
                document.getElementById('rate-amount').value = rateToEdit.amount;
                rateForm.dataset.editingIndex = index;
                rateForm.style.display = 'block';
                showRateAddBtn.style.display = 'none';
                document.getElementById('rate-form').scrollIntoView({ behavior: 'smooth' });
            });
        });

        document.querySelectorAll('.delete-rate-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const index = e.currentTarget.dataset.index;
                if (confirm('Are you sure you want to delete this rate?')) {
                    rates.splice(index, 1);
                    saveRates();
                }
            });
        });
    }

    function populateRateSelects() {
        rateSelect.innerHTML = '';
        callRateSelect.innerHTML = '';
        rates.forEach(rate => {
            const option = document.createElement('option');
            option.value = rate.amount;
            option.textContent = `${rate.name} ($${rate.amount.toFixed(2)}/min)`;
            rateSelect.appendChild(option);
            const option2 = option.cloneNode(true);
            callRateSelect.appendChild(option2);
        });
    }

    // Call Log Management
    function displayCalls() {
        callLogTableBody.innerHTML = '';
        
        let filteredCalls = [];
        const now = new Date();
        
        if (callLogFilter === 'today') {
            const startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            filteredCalls = calls.filter(call => new Date(call.startTime) >= startDate);
        } else if (callLogFilter === 'week') {
            const startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 7);
            filteredCalls = calls.filter(call => new Date(call.startTime) >= startDate);
        } else if (callLogFilter === 'month') {
            const startDate = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
            filteredCalls = calls.filter(call => new Date(call.startTime) >= startDate);
        } else if (callLogFilter === 'date') {
            const selectedDate = statsDatePicker.value;
            filteredCalls = calls.filter(call => new Date(call.startTime).toISOString().split('T')[0] === selectedDate);
        }

        const sortedCalls = [...filteredCalls].sort((a, b) => new Date(b.startTime) - new Date(a.startTime));
        
        const totalDuration = filteredCalls.reduce((sum, call) => sum + call.duration, 0);
        const totalEarnings = filteredCalls.reduce((sum, call) => sum + call.earned, 0);
        totalMinutesDisplay.textContent = formatTime(totalDuration);
        totalEarningsDisplay.textContent = formatEarnings(totalEarnings);
        
        if (sortedCalls.length === 0) {
            callLogTableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-500 dark:text-gray-400">No calls logged for this period.</td></tr>`;
            return;
        }

        sortedCalls.forEach((call, index) => {
            const originalIndex = calls.findIndex(c => c.startTime === call.startTime && c.duration === call.duration);
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors duration-150';
            const rateName = rates.find(r => r.amount === call.rate)?.name || 'N/A';
            row.innerHTML = `
                <td class="px-4 py-2">${formatDateTime(call.startTime)}</td>
                <td class="px-4 py-2">${formatTime(call.duration)}</td>
                <td class="px-4 py-2"><span class="tag">$${call.rate.toFixed(2)}/min</span></td>
                <td class="px-4 py-2 font-bold">${formatEarnings(call.earned)}</td>
                <td class="px-4 py-2 text-right w-36">
                    <button class="edit-call-btn text-blue-500 hover:text-blue-700 mr-2" data-index="${originalIndex}">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="delete-call-btn text-red-500 hover:text-red-700" data-index="${originalIndex}">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            callLogTableBody.appendChild(row);
        });

        document.querySelectorAll('.delete-call-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const index = parseInt(e.currentTarget.dataset.index);
                deleteCall(index);
            });
        });
        
        document.querySelectorAll('.edit-call-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const index = parseInt(e.currentTarget.dataset.index);
                editCall(index);
            });
        });
    }

    function deleteCall(index) {
        if (confirm("Are you sure you want to delete this call entry?")) {
            calls.splice(index, 1);
            saveCalls();
        }
    }

    function editCall(index) {
        const callToEdit = calls[index];
        isEditingCall = true;
        editingCallIndex = index;
        document.getElementById('modal-title').textContent = 'Edit Call';
        callForm.dataset.editingIndex = index;

        const date = new Date(callToEdit.startTime);
        const yyyy = date.getFullYear();
        const mm = String(date.getMonth() + 1).padStart(2, '0');
        const dd = String(date.getDate()).padStart(2, '0');
        const hh = String(date.getHours()).padStart(2, '0');
        const min = String(date.getMinutes()).padStart(2, '0');
        callDateInput.value = `${yyyy}-${mm}-${dd}T${hh}:${min}`;
        
        const durationSeconds = Math.floor(callToEdit.duration / 1000);
        callDurationHoursInput.value = Math.floor(durationSeconds / 3600);
        callDurationMinutesInput.value = Math.floor((durationSeconds % 3600) / 60);
        callDurationSecondsInput.value = durationSeconds % 60;
        
        callRateSelect.value = callToEdit.rate;

        callModal.style.display = 'flex';
    }

    function handleCallFormSubmit(e) {
        e.preventDefault();
        
        const durationHours = parseInt(callDurationHoursInput.value) || 0;
        const durationMinutes = parseInt(callDurationMinutesInput.value) || 0;
        const durationSeconds = parseInt(callDurationSecondsInput.value) || 0;
        const totalDuration = (durationHours * 3600 + durationMinutes * 60 + durationSeconds) * 1000;
        const rate = parseFloat(callRateSelect.value);
        const earnings = (totalDuration / (1000 * 60)) * rate;

        // Bug Fix 2: Manually parse datetime-local to handle timezone correctly
        const dateTimeLocalStr = callDateInput.value;
        const parts = dateTimeLocalStr.match(/(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2})/);
        const callDate = new Date(parts[1], parts[2] - 1, parts[3], parts[4], parts[5]);

        const newCall = {
            startTime: callDate.toISOString(),
            duration: totalDuration,
            rate: rate,
            earned: earnings
        };

        if (isEditingCall) {
            calls[editingCallIndex] = newCall;
        } else {
            // Bug Fix 3: Ensure new call is pushed to the global calls array
            calls.push(newCall);
        }

        saveCalls();
        closeCallModal();
    }
    
    // Live Call Logic
    function startLiveCall() {
        if (liveCallTimerId) {
            alert('A call is already in progress.');
            return;
        }
        if (rates.length === 0) {
            alert('Please add a rate before starting a call.');
            return;
        }
        startCallBtn.style.display = 'none';
        endCallBtn.style.display = 'block';
        liveCallInfo.style.display = 'flex';
        // UI Improvement: Add pulse effect to live call info box
        liveCallInfo.classList.add('active-call-pulse');

        liveCallStart = Date.now();
        currentCallRate = parseFloat(rateSelect.value);

        liveCallTimerId = setInterval(() => {
            const elapsed = Date.now() - liveCallStart;
            liveCallTimerDisplay.textContent = formatTime(elapsed);
            const earnings = (elapsed / (1000 * 60)) * currentCallRate;
            liveCallEarningsDisplay.textContent = formatEarnings(earnings);
        }, 1000);
        activeTimers.add(liveCallTimerId);
    }

    function endLiveCall() {
        if (!liveCallTimerId) return;

        clearInterval(liveCallTimerId);
        activeTimers.delete(liveCallTimerId);
        liveCallTimerId = null;

        const endTime = Date.now();
        const duration = endTime - liveCallStart;
        const earned = (duration / (1000 * 60)) * currentCallRate;

        const newCall = {
            startTime: new Date(liveCallStart).toISOString(),
            duration: duration,
            rate: currentCallRate,
            earned: earned
        };

        calls.push(newCall);
        saveCalls();

        startCallBtn.style.display = 'block';
        endCallBtn.style.display = 'none';
        liveCallInfo.style.display = 'none';
        // UI Improvement: Remove pulse effect
        liveCallInfo.classList.remove('active-call-pulse');
        liveCallTimerDisplay.textContent = '00:00:00';
        liveCallEarningsDisplay.textContent = '$0.00 earned';
    }

    // Modal Functions
    function openCallModal() {
        isEditingCall = false;
        editingCallIndex = null;
        document.getElementById('modal-title').textContent = 'Add Call';
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hour = String(now.getHours()).padStart(2, '0');
        const minute = String(now.getMinutes()).padStart(2, '0');
        callDateInput.value = `${year}-${month}-${day}T${hour}:${minute}`;
        callDurationHoursInput.value = 0;
        callDurationMinutesInput.value = 0;
        callDurationSecondsInput.value = 0;
        if (rates.length > 0) {
            callRateSelect.value = rateSelect.value;
        }
        callModal.style.display = 'flex';
    }

    function closeCallModal() {
        callModal.style.display = 'none';
    }

    function openSettingsModal() {
        settingsModal.style.display = 'flex';
    }

    function closeSettingsModal() {
        settingsModal.style.display = 'none';
    }

    function openEditCycleModal() {
        editCycleModal.style.display = 'flex';
    }

    function closeEditCycleModal() {
        editCycleModal.style.display = 'none';
        isEditingCycle = false;
        editingCycleIndex = null;
        editCycleForm.reset();
    }

    // Payment Cycle Management
    function renderPaymentCycles() {
        paymentCyclesToggle.checked = paymentCyclesEnabled;
        if (paymentCyclesEnabled) {
            paymentCyclesConfig.classList.remove('hidden');
        } else {
            paymentCyclesConfig.classList.add('hidden');
        }

        paymentCyclesList.innerHTML = '';
        if (paymentCycles.length === 0) {
            paymentCyclesList.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-500 dark:text-gray-400">No cycles configured.</td></tr>`;
            return;
        }
        
        const sortedCycles = [...paymentCycles].sort((a, b) => new Date(b.startDate) - new Date(a.startDate));

        sortedCycles.forEach((cycle, index) => {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors';
            const originalIndex = paymentCycles.findIndex(c => c.startDate === cycle.startDate && c.endDate === cycle.endDate);
            
            const startDisplay = new Date(cycle.startDate).toLocaleDateString();
            const endDisplay = new Date(cycle.endDate).toLocaleDateString();
            const payDisplay = new Date(cycle.payDate).toLocaleDateString();

            row.innerHTML = `
                <td class="px-2 py-2">${startDisplay}</td>
                <td class="px-2 py-2">${endDisplay}</td>
                <td class="px-2 py-2">${payDisplay}</td>
                <td class="px-2 py-2 text-right">
                    <button class="edit-cycle-btn text-blue-500 hover:text-blue-700 mr-2" data-index="${originalIndex}">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="delete-cycle-btn text-red-500 hover:text-red-700" data-index="${originalIndex}">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            paymentCyclesList.appendChild(row);
        });

        document.querySelectorAll('.edit-cycle-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const index = parseInt(e.currentTarget.dataset.index);
                editPaymentCycle(index);
            });
        });

        document.querySelectorAll('.delete-cycle-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const index = parseInt(e.currentTarget.dataset.index);
                if (confirm('Are you sure you want to delete this payment cycle?')) {
                    paymentCycles.splice(index, 1);
                    savePaymentCycles();
                }
            });
        });

        const statsContainer = document.getElementById('stats-date-picker').closest('.bg-white');
        const monthlyContainer = document.getElementById('monthly-earnings-cards').closest('.grid');
        const cycleContainer = document.getElementById('payment-cycle-earnings-cards').closest('.grid');
        if (paymentCyclesEnabled) {
            monthlyEarningsCards.classList.add('hidden');
            paymentCycleEarningsCards.classList.remove('hidden');
        } else {
            monthlyEarningsCards.classList.remove('hidden');
            paymentCycleEarningsCards.classList.add('hidden');
        }
    }

    function addPaymentCycle() {
        isEditingCycle = false;
        document.getElementById('edit-cycle-modal-title').textContent = 'Add Payment Cycle';
        openEditCycleModal();
    }

    function editPaymentCycle(index) {
        const cycleToEdit = paymentCycles[index];
        isEditingCycle = true;
        editingCycleIndex = index;
        document.getElementById('edit-cycle-modal-title').textContent = 'Edit Payment Cycle';

        cycleStartDateInput.value = cycleToEdit.startDate.split('T')[0];
        cycleEndDateInput.value = cycleToEdit.endDate.split('T')[0];
        cyclePayDateInput.value = cycleToEdit.payDate.split('T')[0];
        openEditCycleModal();
    }

    function handleEditCycleFormSubmit(e) {
        e.preventDefault();

        // Fix for timezone bug: use UTC dates
        const startDate = new Date(cycleStartDateInput.value);
        const endDate = new Date(cycleEndDateInput.value);
        const payDate = new Date(cyclePayDateInput.value);

        if (!startDate || !endDate || !payDate) {
            alert('Please fill in all dates.');
            return;
        }

        // Normalize to start of day in UTC
        const start = new Date(startDate.getUTCFullYear(), startDate.getUTCMonth(), startDate.getUTCDate());
        const end = new Date(endDate.getUTCFullYear(), endDate.getUTCMonth(), endDate.getUTCDate());
        const pay = new Date(payDate.getUTCFullYear(), payDate.getUTCMonth(), payDate.getUTCDate());

        if (end < start) {
            alert('End date cannot be before start date.');
            return;
        }

        const newCycle = {
            startDate: start.toISOString(),
            endDate: end.toISOString(),
            payDate: pay.toISOString()
        };

        if (isEditingCycle) {
            paymentCycles[editingCycleIndex] = newCycle;
        } else {
            paymentCycles.push(newCycle);
        }

        savePaymentCycles();
        closeEditCycleModal();
        showToast('Payment cycle saved!');
    }
    
    // UI function to handle active filter button styling
    function updateCallLogFilterButtons() {
        const buttons = [filterTodayBtn, filterWeekBtn, filterMonthBtn];
        buttons.forEach(btn => {
            btn.classList.remove('bg-blue-500', 'text-white', 'dark:bg-blue-600', 'dark:text-white');
            btn.classList.add('bg-gray-200', 'text-gray-700', 'dark:bg-gray-700', 'dark:text-gray-200');
        });

        const activeBtn = document.getElementById(`filter-${callLogFilter}`);
        if (activeBtn) {
            activeBtn.classList.remove('bg-gray-200', 'text-gray-700', 'dark:bg-gray-700', 'dark:text-gray-200');
            activeBtn.classList.add('bg-blue-500', 'text-white', 'dark:bg-blue-600', 'dark:text-white');
        }
    }


    // Event Listeners
    document.addEventListener('DOMContentLoaded', () => {
        // Populate timezone select
    function populateTimezones() {
        const timeZones = Intl.supportedValuesOf('timeZone');
        timezoneSelect.innerHTML = timeZones.map(zone => 
            `<option value="${zone}" ${zone === userTimezone ? 'selected' : ''}>${zone.replace(/_/g, ' ')}</option>`
        ).join('');
    }
        // Tracker buttons
        startCallBtn.addEventListener('click', startLiveCall);
        endCallBtn.addEventListener('click', endLiveCall);
        addCallBtn.addEventListener('click', openCallModal);
        
        // Modals
        closeModalBtn.addEventListener('click', closeCallModal);
        cancelCallBtn.addEventListener('click', closeCallModal);
        callForm.addEventListener('submit', handleCallFormSubmit);
        window.addEventListener('click', (e) => {
            if (e.target === callModal) {
                closeCallModal();
            }
            if (e.target === settingsModal) {
                closeSettingsModal();
            }
            if (e.target === editCycleModal) {
                closeEditCycleModal();
            }
        });
        
        // New Payment Cycle Modal
        showAddCycleBtn.addEventListener('click', addPaymentCycle);
        closeEditCycleModalBtn.addEventListener('click', closeEditCycleModal);
        cancelEditCycleBtn.addEventListener('click', closeEditCycleModal);
        editCycleForm.addEventListener('submit', handleEditCycleFormSubmit);

        // Dark Mode
        darkToggleBtn.addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        });
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        }

// Timezone change handler
    timezoneSelect.addEventListener('change', (e) => {
        userTimezone = e.target.value;
        localStorage.setItem('userTimezone', userTimezone);
        displayCalls();      // Updates the call log table
        updateStatistics(); // Updates all stats (daily/monthly earnings, etc.)
        updateLocalTime();  // Updates the time shown in footer
        showToast('Time zone updated!');
    });        

        // Rates
        rateSelect.addEventListener('change', saveLastSelectedRate);
        showRateAddBtn.addEventListener('click', () => {
            rateForm.style.display = 'block';
            showRateAddBtn.style.display = 'none';
            document.getElementById('rate-name').focus();
        });
        cancelRateAddBtn.addEventListener('click', () => {
            rateForm.style.display = 'none';
            showRateAddBtn.style.display = 'block';
        });
        rateForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('rate-name').value;
            const amount = parseFloat(document.getElementById('rate-amount').value);

            if (!name || isNaN(amount) || amount <= 0) {
                alert('Please enter a valid rate name and amount.');
                return;
            }

            if (rateForm.dataset.editingIndex) {
                const index = parseInt(rateForm.dataset.editingIndex);
                rates[index] = { name, amount };
                delete rateForm.dataset.editingIndex;
            } else {
                rates.push({ name, amount });
            }

            saveRates();
            rateForm.reset();
            rateForm.style.display = 'none';
            showRateAddBtn.style.display = 'block';
        });

        // Daily Goal
        goalForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const amount = parseFloat(goalAmountInput.value) || 0;
            dailyGoal.amount = amount;
            saveDailyGoal();
            goalAmountInput.blur();
            showToast('Daily goal saved!');
        });
        
        // Stats Date Picker
        statsDatePicker.addEventListener('change', () => {
            callLogFilter = 'date';
            updateStatistics();
            displayCalls();
            updateCallLogFilterButtons();
        });
        currentDateBtn.addEventListener('click', () => {
            const today = new Date().toISOString().split('T')[0];
            statsDatePicker.value = today;
            callLogFilter = 'today';
            updateStatistics();
            displayCalls();
            updateCallLogFilterButtons();
        });
        
        // Settings
        settingsToggleBtn.addEventListener('click', openSettingsModal);
        closeSettingsModalBtn.addEventListener('click', closeSettingsModal);
        
        // Data Management
        exportDataBtn.addEventListener('click', () => {
            const data = {
                calls: calls,
                rates: rates,
                dailyGoal: dailyGoal,
                paymentCyclesEnabled: paymentCyclesEnabled,
                paymentCycles: paymentCycles
            };
            const dataStr = JSON.stringify(data, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `work-time-tracker-data-${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('Data exported successfully!');
        });
        
        importFile.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const importedData = JSON.parse(event.target.result);
                    if (confirm('Importing data will overwrite your current data. Are you sure?')) {
                        calls = importedData.calls || [];
                        rates = importedData.rates || [];
                        dailyGoal = importedData.dailyGoal || { amount: 0 };
                        paymentCyclesEnabled = importedData.paymentCyclesEnabled || false;
                        paymentCycles = importedData.paymentCycles || [];
                        saveRates();
                        saveCalls();
                        saveDailyGoal();
                        savePaymentCycles();
                        populateRateSelects();
                        showToast('Data imported successfully!');
                        closeSettingsModal();
                    }
                } catch (error) {
                    alert('Failed to import file. Please ensure it is a valid JSON file from this app.');
                    console.error('Import error:', error);
                }
            };
            reader.readAsText(file);
        });

        resetCallsBtn.addEventListener('click', () => {
            if (confirm("Are you sure you want to erase all call history? This cannot be undone.")) {
                calls = [];
                saveCalls();
                showToast('All call history erased.');
            }
        });
        
        resetAllBtn.addEventListener('click', () => {
            if (confirm("Are you sure you want to reset all data, including rates, goals, and call history? This cannot be undone.")) {
                localStorage.clear();
                calls = [];
                rates = [];
                dailyGoal = { amount: 0 };
                paymentCyclesEnabled = false;
                paymentCycles = [];
                saveRates();
                saveCalls();
                saveDailyGoal();
                savePaymentCycles();
                populateRateSelects();
                showToast('All data reset.');
                closeSettingsModal();
            }
        });
        
        // Payment Cycles
        paymentCyclesToggle.addEventListener('change', (e) => {
            paymentCyclesEnabled = e.target.checked;
            savePaymentCycles();
        });
        
        // Toast Notification
        function showToast(message) {
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                background-color: #333;
                color: white;
                padding: 10px 20px;
                border-radius: 5px;
                z-index: 1000;
                opacity: 0;
                transition: opacity 0.5s, transform 0.5s;
                font-family: sans-serif;
            `;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '1';
                toast.style.transform = 'translate(-50%, -10px)';
            }, 10);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translate(-50%, 0)';
            }, 2500);
            setTimeout(() => {
                document.body.removeChild(toast);
            }, 3000);
        }

        // Global Event Listeners
        function handleModalKeyboard(e) {
            if (e.key === 'Escape') {
                if (callModal.style.display === 'flex') {
                    closeCallModal();
                }
                if (settingsModal.style.display === 'flex') {
                    closeSettingsModal();
                }
                if (editCycleModal.style.display === 'flex') {
                    closeEditCycleModal();
                }
            }
        }
        
        document.addEventListener('keydown', handleModalKeyboard);
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            activeTimers.forEach(timerId => clearInterval(timerId));
            activeTimers.clear();
        });

        // Footer button handlers
        document.getElementById('privacy-policy')?.addEventListener('click', () => {
            alert('Privacy Policy: This app stores all data locally in your browser. No data is sent to external servers.');
        });

        document.getElementById('terms-of-service')?.addEventListener('click', () => {
            alert('Terms of Service: This app is provided "as is" without any warranties. Use at your own discretion.');
        });
        
        // Initialize displays and add event listeners
        loadCardPositions();
        setupDragAndDrop();
        displayRates();
        populateRateSelects(); // Call before setting the value
        if (rates.length > 0 && lastSelectedRate) {
            rateSelect.value = lastSelectedRate;
        }

        displayCalls();
        updateStatistics();
        updateStorageInfo();
        renderPaymentCycles();
        updateLocalTime();
        populateTimezones();
        setInterval(updateLocalTime, 1000);

        // Set default date for stats date picker
        const today = new Date().toISOString().split('T')[0];
        statsDatePicker.value = today;
        
        // Call log filter button event listeners
        filterTodayBtn.addEventListener('click', () => {
            callLogFilter = 'today';
            displayCalls();
            updateCallLogFilterButtons();
        });
        filterWeekBtn.addEventListener('click', () => {
            callLogFilter = 'week';
            displayCalls();
            updateCallLogFilterButtons();
        });
        filterMonthBtn.addEventListener('click', () => {
            callLogFilter = 'month';
            displayCalls();
            updateCallLogFilterButtons();
        });
        updateCallLogFilterButtons(); // Initial call to set active button styling
    });
</script>
</body>
</html>
